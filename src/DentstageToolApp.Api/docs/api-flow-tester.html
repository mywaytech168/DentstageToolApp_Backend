<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dentstage Tool App API 流程測試工具</title>
  <!-- 使用 Element Plus 的預設樣式，確保排版一致 -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
  <!-- 內嵌 SVG favicon，避免瀏覽器預設要求 favicon.ico 造成 404 -->
  <link
    rel="icon"
    type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='4' ry='4' fill='%2320a0ff'/%3E%3Ctext x='12' y='16' font-size='12' text-anchor='middle' fill='white' font-family='Arial, sans-serif'%3EDT%3C/text%3E%3C/svg%3E"
  />
  <style>
    body {
      background-color: #f5f7fa;
      margin: 0;
      padding: 16px;
      font-family: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    pre {
      background-color: #1e1e1e;
      color: #e1e1e1;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .card-spacer {
      margin-bottom: 16px;
    }
    .request-url-preview {
      font-size: 12px;
      color: #909399;
    }
    .log-card {
      margin-bottom: 12px;
    }
    .operation-tools {
      margin-bottom: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .log-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .result-viewer {
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- 採用全域腳本引入，避免瀏覽器無法解析裸模組名稱造成空白頁面 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
  <script src="https://unpkg.com/element-plus/dist/locale/zh-tw.min.js"></script>

  <script>
    // 透過全域 Vue 物件取得 Composition API，確保純靜態頁面也能順利運行
    const { createApp, ref, reactive, watch, onMounted, computed } = Vue;
    const elementPlus = window.ElementPlus;
    const zhTwLocale = window.ElementPlusLocaleZhTw?.default ?? window.ElementPlusLocaleZhTw;

    // 解析網址查詢參數，支援自動選取目標 API 與指定 Swagger 來源。
    const urlParams = new URLSearchParams(window.location.search);
    const initialSpecUrl = urlParams.get('specUrl') || '';
    const initialOperationId = urlParams.get('operationId') || '';
    const initialOperationPath = urlParams.get('path') || '';
    const initialOperationMethod = (urlParams.get('method') || '').toUpperCase();
    const initialOperationTag = urlParams.get('tag') || '';

    if (!elementPlus) {
      // 若 Element Plus 未成功載入，提前拋出錯誤提醒開發者檢查網路或 CDN 狀態
      throw new Error('Element Plus 載入失敗，請確認 CDN 狀態。');
    }

    if (!zhTwLocale) {
      // 若語系檔未載入成功，僅提示警告並繼續使用預設英文語系
      console.warn('Element Plus 繁體中文語系載入失敗，將使用預設語系。');
    }

    // ---------- 常數區 ----------
    const STORAGE_KEY = 'dentstage-flow-tester-settings';

    const App = {
      // ---------- 模板區 ----------
      template: `
        <el-config-provider namespace="el">
          <div>
            <el-page-header content="Dentstage Tool App API 流程測試工具" icon=""></el-page-header>

            <div class="card-spacer">
              <el-card>
                <template #header>
                  <span>環境設定</span>
                </template>
                <el-form label-width="120px" label-position="left">
                  <el-form-item label="API 基底網址">
                    <el-input v-model="baseUrl" placeholder="例如：https://localhost:7249/api" />
                  </el-form-item>
                  <el-form-item label="裝置機碼">
                    <el-input v-model="authState.deviceKey" placeholder="請輸入登入使用的裝置機碼" />
                  </el-form-item>
                  <el-form-item label="Access Token">
                    <el-input v-model="authState.accessToken" type="textarea" :rows="2" placeholder="登入成功後會自動帶入" />
                  </el-form-item>
                  <el-form-item label="Refresh Token">
                    <el-input v-model="authState.refreshToken" type="textarea" :rows="2" placeholder="登入成功後會自動帶入" />
                  </el-form-item>
                  <el-form-item>
                    <el-button type="primary" @click="login" :loading="loginLoading">登入取得權杖</el-button>
                    <el-button type="success" @click="refreshToken" :loading="refreshLoading">刷新 Access Token</el-button>
                    <el-button type="info" @click="fetchUserInfo" :loading="infoLoading">取得登入者資訊</el-button>
                    <el-button type="warning" @click="clearTokens">清除權杖</el-button>
                  </el-form-item>
                </el-form>
              </el-card>
            </div>

            <div class="card-spacer">
              <el-card>
                <template #header>
                  <span>API 操作快速帶入</span>
                </template>
                <el-form label-width="120px" label-position="left">
                  <el-form-item label="Swagger 定義網址">
                    <el-input
                      v-model="swaggerState.specUrl"
                      @input="handleSpecUrlInput"
                      clearable
                      placeholder="例如：https://localhost:7249/swagger/v1/swagger.json"
                    >
                      <template #append>
                        <el-button
                          type="primary"
                          @click="loadSwaggerOperations"
                          :loading="swaggerState.loading"
                        >載入 API</el-button>
                      </template>
                    </el-input>
                  </el-form-item>
                  <el-form-item label="API 列表狀態">
                    <el-space wrap>
                      <el-tag type="info">自動載入 {{ swaggerOperationCount }} 筆</el-tag>
                      <el-tag type="success">當前顯示 {{ totalVisibleOperations }} 筆</el-tag>
                      <span v-if="swaggerState.lastLoadedAt" class="request-url-preview">
                        最近更新：{{ formatTimestamp(swaggerState.lastLoadedAt) }}
                      </span>
                    </el-space>
                  </el-form-item>
                  <el-form-item label="關鍵字篩選">
                    <el-input
                      v-model="operationKeyword"
                      clearable
                      placeholder="輸入名稱、路徑或描述關鍵字"
                    />
                  </el-form-item>
                </el-form>
                <el-alert
                  v-if="swaggerState.error"
                  type="error"
                  :closable="false"
                  show-icon
                  title="載入 Swagger 失敗"
                  :description="swaggerState.error"
                  style="margin-bottom: 16px;"
                />
                <el-alert
                  v-if="swaggerOperationCount === 0"
                  type="info"
                  :closable="false"
                  show-icon
                  title="目前僅顯示常用範本"
                  description="若需完整 API 清單，請輸入 Swagger 定義網址後載入。"
                  style="margin-bottom: 12px;"
                />
                <div class="operation-tools">
                  <el-tag type="success">顯示 {{ totalVisibleOperations }} 筆操作</el-tag>
                  <el-button type="info" size="small" @click="expandAllGroups">全部展開</el-button>
                  <el-button type="info" size="small" @click="collapseAllGroups">全部收合</el-button>
                </div>
                <el-collapse v-model="activeOperationGroups">
                  <el-collapse-item
                    v-for="group in operationGroups"
                    :key="group.name"
                    :title="group.name"
                    :name="group.name"
                  >
                    <el-descriptions :column="1" border>
                      <el-descriptions-item
                        v-for="operation in group.operations"
                        :key="operation.displayName + operation.method + operation.path"
                      >
                        <template #label>
                          <div>
                            <strong>{{ operation.displayName }}</strong>
                            <div class="request-url-preview">{{ operation.description || '尚未撰寫補充說明' }}</div>
                          </div>
                        </template>
                        <div class="operation-body">
                          <div class="request-url-preview">{{ operation.method }} {{ composeUrl(operation.path) }}</div>
                          <el-space wrap>
                            <el-tag :type="operation.requiresAuth ? 'danger' : 'info'" effect="plain">
                              {{ operation.requiresAuth ? '需權杖' : '免權杖' }}
                            </el-tag>
                            <el-button type="primary" size="small" @click="prefillOperation(operation)">帶入到自訂請求</el-button>
                            <el-button
                              v-if="operation.swaggerLink"
                              type="success"
                              size="small"
                              :href="operation.swaggerLink"
                              target="_blank"
                              rel="noopener"
                            >Swagger</el-button>
                          </el-space>
                        </div>
                      </el-descriptions-item>
                    </el-descriptions>
                  </el-collapse-item>
                </el-collapse>
              </el-card>
            </div>

            <div class="card-spacer">
              <el-card>
                <template #header>
                  <span>自訂 JSON 請求</span>
                </template>
                <el-form label-width="120px" label-position="left">
                  <el-form-item label="HTTP 方法">
                    <el-select v-model="requestForm.method">
                      <el-option label="GET" value="GET" />
                      <el-option label="POST" value="POST" />
                      <el-option label="PUT" value="PUT" />
                      <el-option label="PATCH" value="PATCH" />
                      <el-option label="DELETE" value="DELETE" />
                    </el-select>
                  </el-form-item>
                  <el-form-item label="路徑">
                    <el-input v-model="requestForm.path" placeholder="例如：/customers" />
                    <div class="request-url-preview">完整網址：{{ composeUrl(requestForm.path) }}</div>
                  </el-form-item>
                  <el-form-item label="攜帶權杖">
                    <el-switch v-model="requestForm.useAuth" />
                  </el-form-item>
                  <el-form-item label="JSON Body" v-if="requestForm.method !== 'GET'">
                    <el-input
                      v-model="requestForm.body"
                      type="textarea"
                      :rows="12"
                      placeholder="請輸入 JSON 內容，若無需 Body 可留空"
                    />
                  </el-form-item>
                  <el-form-item>
                    <el-button type="primary" @click="sendCustomRequest" :loading="requestLoading">送出請求</el-button>
                  </el-form-item>
                </el-form>
                <div v-if="customRequestState.summary" class="card-spacer" style="margin-top: 12px;">
                  <el-alert
                    :type="customRequestState.success ? 'success' : 'error'"
                    :title="customRequestState.success ? '請求成功' : '請求失敗'"
                    :description="customRequestState.message"
                    :closable="false"
                    show-icon
                    style="margin-bottom: 12px;"
                  />
                  <div class="operation-tools" style="justify-content: space-between;">
                    <el-space wrap>
                      <el-tag :type="customRequestState.success ? 'success' : 'danger'" effect="dark">
                        {{ customRequestState.summary.status }}
                      </el-tag>
                      <span class="request-url-preview">最近更新：{{ formatTimestamp(customRequestState.updatedAt) }}</span>
                    </el-space>
                    <el-button
                      type="primary"
                      size="small"
                      @click="copyContent(customRequestState.summary.body, '回應內容')"
                    >複製回應</el-button>
                  </div>
                  <el-descriptions :column="1" border size="small" style="margin-bottom: 12px;">
                    <el-descriptions-item label="回應標頭">
                      <pre>{{ formatJson(customRequestState.summary.headers) }}</pre>
                    </el-descriptions-item>
                  </el-descriptions>
                  <el-tabs v-model="responseViewerState.customRequest" type="card" class="result-viewer">
                    <el-tab-pane label="格式化 JSON" name="formatted">
                      <pre>{{ formatJson(customRequestState.summary.body) }}</pre>
                    </el-tab-pane>
                    <el-tab-pane label="原始資料" name="raw">
                      <pre>{{ toRawText(customRequestState.summary.body) }}</pre>
                    </el-tab-pane>
                  </el-tabs>
                </div>
              </el-card>
            </div>

            <div class="card-spacer">
              <el-row :gutter="16">
                <el-col :span="12">
                  <el-card>
                    <template #header>
                      <span>車牌辨識測試</span>
                    </template>
                    <el-form label-width="120px" label-position="left">
                      <el-form-item label="上傳照片">
                        <el-upload
                          action=""
                          :auto-upload="false"
                          :file-list="carPlateForm.fileList"
                          :on-change="handleCarPlateFileChange"
                          :on-remove="handleCarPlateFileRemove"
                          accept="image/*"
                          list-type="text"
                        >
                          <el-button type="primary">選擇圖片</el-button>
                        </el-upload>
                      </el-form-item>
                      <el-form-item label="或貼上 Base64">
                        <el-input
                          v-model="carPlateForm.imageBase64"
                          type="textarea"
                          :rows="6"
                          placeholder="貼上 data:image/...;base64,xxx 格式的字串"
                        />
                      </el-form-item>
                      <el-form-item>
                        <el-button type="primary" @click="sendCarPlateRecognition" :loading="carPlateForm.loading">送出辨識</el-button>
                      </el-form-item>
                    </el-form>
                    <div v-if="carPlateForm.result">
                      <div class="operation-tools" style="justify-content: space-between;">
                        <h4 style="margin:0;">辨識結果</h4>
                        <el-button type="primary" size="small" @click="copyContent(carPlateForm.result, '辨識結果')">複製結果</el-button>
                      </div>
                      <el-tabs v-model="responseViewerState.carPlate" type="card" class="result-viewer">
                        <el-tab-pane label="格式化 JSON" name="formatted">
                          <pre>{{ formatJson(carPlateForm.result) }}</pre>
                        </el-tab-pane>
                        <el-tab-pane label="原始資料" name="raw">
                          <pre>{{ toRawText(carPlateForm.result) }}</pre>
                        </el-tab-pane>
                      </el-tabs>
                    </div>
                  </el-card>
                </el-col>
                <el-col :span="12">
                  <el-card>
                    <template #header>
                      <span>車牌維修紀錄查詢</span>
                    </template>
                    <el-form label-width="120px" label-position="left">
                      <el-form-item label="車牌號碼">
                        <el-input v-model="carPlateSearchForm.carPlateNumber" placeholder="例如：AAA-1234" />
                      </el-form-item>
                      <el-form-item>
                        <el-button type="primary" @click="searchCarPlateHistory" :loading="carPlateSearchForm.loading">查詢紀錄</el-button>
                      </el-form-item>
                    </el-form>
                    <div v-if="carPlateSearchForm.result">
                      <div class="operation-tools" style="justify-content: space-between;">
                        <h4 style="margin:0;">查詢結果</h4>
                        <el-button type="primary" size="small" @click="copyContent(carPlateSearchForm.result, '查詢結果')">複製結果</el-button>
                      </div>
                      <el-tabs v-model="responseViewerState.carPlateSearch" type="card" class="result-viewer">
                        <el-tab-pane label="格式化 JSON" name="formatted">
                          <pre>{{ formatJson(carPlateSearchForm.result) }}</pre>
                        </el-tab-pane>
                        <el-tab-pane label="原始資料" name="raw">
                          <pre>{{ toRawText(carPlateSearchForm.result) }}</pre>
                        </el-tab-pane>
                      </el-tabs>
                    </div>
                  </el-card>
                </el-col>
              </el-row>
            </div>

            <div class="card-spacer">
              <el-card>
                <template #header>
                  <span>圖片上傳測試</span>
                </template>
                <el-form label-width="120px" label-position="left">
                  <el-form-item label="選擇圖片">
                    <el-upload
                      action=""
                      :auto-upload="false"
                      :file-list="photoUploadForm.fileList"
                      :on-change="handlePhotoFileChange"
                      :on-remove="handlePhotoFileRemove"
                      accept="image/*"
                      list-type="text"
                    >
                      <el-button type="primary">選擇圖片</el-button>
                    </el-upload>
                  </el-form-item>
                  <el-form-item>
                    <el-button type="primary" @click="uploadPhoto" :loading="photoUploadForm.loading">上傳圖片</el-button>
                  </el-form-item>
                </el-form>
                <div v-if="photoUploadForm.result">
                  <div class="operation-tools" style="justify-content: space-between;">
                    <h4 style="margin:0;">上傳回應</h4>
                    <el-button type="primary" size="small" @click="copyContent(photoUploadForm.result, '上傳回應')">複製結果</el-button>
                  </div>
                  <el-tabs v-model="responseViewerState.photoUpload" type="card" class="result-viewer">
                    <el-tab-pane label="格式化 JSON" name="formatted">
                      <pre>{{ formatJson(photoUploadForm.result) }}</pre>
                    </el-tab-pane>
                    <el-tab-pane label="原始資料" name="raw">
                      <pre>{{ toRawText(photoUploadForm.result) }}</pre>
                    </el-tab-pane>
                  </el-tabs>
                </div>
              </el-card>
            </div>

            <div class="card-spacer">
              <el-card>
                <template #header>
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>呼叫紀錄</span>
                    <el-button type="danger" size="small" @click="clearLogs">清除紀錄</el-button>
                  </div>
                </template>
                <div v-if="logs.length === 0" style="color:#909399;">尚未有任何呼叫紀錄。</div>
                <div v-else>
                  <el-timeline>
                    <el-timeline-item
                      v-for="log in logs"
                      :key="log.id"
                      :timestamp="formatTimestamp(log.timestamp)"
                      :color="log.isError ? '#F56C6C' : '#67C23A'"
                    >
                      <el-card class="log-card" shadow="hover">
                        <div class="log-actions">
                          <h4 style="margin:0;">{{ log.title }}</h4>
                          <el-tag :type="log.isError ? 'danger' : 'success'" effect="dark">{{ log.response.status }}</el-tag>
                          <el-button type="primary" size="small" @click="copyContent(log.request, '請求資訊')">複製請求</el-button>
                          <el-button type="success" size="small" @click="copyContent(log.response, '回應資訊')">複製回應</el-button>
                        </div>
                        <p style="font-size:12px;color:#909399; margin-bottom:8px;">{{ log.request.method }} {{ log.request.url }}</p>
                        <el-descriptions :column="1" border size="small">
                          <el-descriptions-item label="請求標頭">
                            <pre>{{ formatJson(log.request.headers) }}</pre>
                          </el-descriptions-item>
                          <el-descriptions-item v-if="log.request.body" label="請求內容">
                            <pre>{{ formatJson(log.request.body) }}</pre>
                          </el-descriptions-item>
                          <el-descriptions-item label="回應標頭">
                            <pre>{{ formatJson(log.response.headers) }}</pre>
                          </el-descriptions-item>
                          <el-descriptions-item label="回應內容">
                            <pre>{{ formatJson(log.response.body) }}</pre>
                          </el-descriptions-item>
                        </el-descriptions>
                        <div v-if="log.errorMessage" class="request-url-preview" style="margin-top:8px;color:#F56C6C;">
                          錯誤訊息：{{ log.errorMessage }}
                        </div>
                      </el-card>
                    </el-timeline-item>
                  </el-timeline>
                </div>
              </el-card>
            </div>
          </div>
        </el-config-provider>
      `,

      // ---------- 邏輯區 ----------
      setup() {
          const baseUrl = ref('https://test-dentstagetoolapp.api.getmywaytech.com/api');
        const authState = reactive({
          deviceKey: 'CFC29A95-885C-CF45-A91C-F0DD3F1DDD7C',
          accessToken: '',
          refreshToken: ''
        });
        const loginLoading = ref(false);
        const refreshLoading = ref(false);
        const infoLoading = ref(false);

        const requestForm = reactive({
          method: 'GET',
          path: '/healthcheck',
          body: '',
          useAuth: false
        });
        const requestLoading = ref(false);

        const carPlateForm = reactive({
          fileList: [],
          imageBase64: '',
          loading: false,
          result: null
        });

        const carPlateSearchForm = reactive({
          carPlateNumber: '',
          loading: false,
          result: null
        });

        const photoUploadForm = reactive({
          fileList: [],
          loading: false,
          result: null
        });

        const logs = ref([]);
        const activeOperationGroups = ref([]);

        // ---------- Swagger 與操作列表狀態 ----------
        const dynamicOperationGroups = ref([]);
        const operationKeyword = ref('');
        const swaggerState = reactive({
          specUrl: initialSpecUrl,
          loading: false,
          lastLoadedAt: null,
          error: ''
        });
        const manualSpecUrl = ref(false);
        if (initialSpecUrl) {
          // 透過外部指定 Swagger 來源時視為手動設定，避免被自動推導覆蓋。
          manualSpecUrl.value = true;
        }
        const hasAutoLoadedSwagger = ref(false);
        const hasAppliedInitialPrefill = ref(false);
        const shouldPrefillFromQuery = Boolean(
          initialOperationId || (initialOperationMethod && initialOperationPath)
        );

        // ---------- 結果檢視狀態 ----------
        const responseViewerState = reactive({
          customRequest: 'formatted',
          carPlate: 'formatted',
          carPlateSearch: 'formatted',
          photoUpload: 'formatted'
        });

        // 依據 API 基底網址推導 Swagger 定義位置，提供使用者快速載入。
        const buildDefaultSpecUrl = (apiBase) => {
          if (!apiBase) {
            return '';
          }
          try {
            const url = new URL(apiBase, window.location.origin);
            const segments = url.pathname
              .split('/')
              .filter((segment) => segment);
            if (segments.length && segments[segments.length - 1].toLowerCase() === 'api') {
              segments.pop();
            }
            segments.push('swagger', 'v1', 'swagger.json');
            url.pathname = `/${segments.join('/')}`;
            url.search = '';
            url.hash = '';
            return url.toString();
          } catch (error) {
            console.warn('無法根據基底網址推導 Swagger 位置：', error);
            return '';
          }
        };

        // 使用者手動輸入 Swagger 網址時標記狀態，避免後續自動覆寫設定。
        const handleSpecUrlInput = (value) => {
          manualSpecUrl.value = true;
          swaggerState.specUrl = value;
        };

        // 監聽 API 基底網址變化，自動重新推導 Swagger 定義路徑。
        watch(
          () => baseUrl.value,
          (value) => {
            if (!manualSpecUrl.value) {
              swaggerState.specUrl = buildDefaultSpecUrl(value);
            }
          },
          { immediate: true }
        );

        // 初次自動載入 Swagger，確保進入頁面即可取得完整 API 列表。
        watch(
          () => swaggerState.specUrl,
          (value) => {
            if (value && !manualSpecUrl.value && !hasAutoLoadedSwagger.value) {
              hasAutoLoadedSwagger.value = true;
              loadSwaggerOperations();
            }
          }
        );

        const composeUrl = (path) => {
          // 若尚未設定基底網址則直接回傳原始路徑，避免產生不可預期的空字串或多餘符號。
          const trimmedBase = (baseUrl.value || '').trim();
          if (!trimmedBase) {
            return path;
          }

          // 規範基底網址與 API 路徑的格式，確保結合時不會多出雙斜線或缺少斜線。
          const normalizedBase = trimmedBase.replace(/\/$/, '');
          const normalizedPath = path.startsWith('/') ? path : `/${path}`;

          // 為避免出現「.../api/api/...」的重複片段，若基底網址已以 /api 結尾，
          // 則刪除路徑開頭對應的 /api，僅保留一次，確保實際呼叫時不會 404。
          if (
            normalizedBase.toLowerCase().endsWith('/api') &&
            normalizedPath.toLowerCase().startsWith('/api/')
          ) {
            return `${normalizedBase}${normalizedPath.slice(4)}`;
          }

          return `${normalizedBase}${normalizedPath}`;
        };

        const formatJson = (value) => {
          if (value === null || value === undefined) {
            return '';
          }
          if (typeof value === 'string') {
            return value;
          }
          try {
            return JSON.stringify(value, null, 2);
          } catch (error) {
            return String(value);
          }
        };

        // ---------- 提示訊息工具 ----------
        const showError = (message) => {
          // 使用全域 Element Plus 訊息元件呈現錯誤，讓使用者快速了解狀況
          elementPlus.ElMessage.error(message);
        };

        const showSuccess = (message) => {
          // 使用全域 Element Plus 訊息元件呈現成功提示，增進操作體驗
          elementPlus.ElMessage.success(message);
        };

        // 將回傳資料轉為原始字串，協助使用者檢查未格式化的內容。
        const toRawText = (value) => {
          if (value === null || value === undefined) {
            return '';
          }
          if (typeof value === 'string') {
            return value;
          }
          try {
            return JSON.stringify(value);
          } catch (error) {
            return String(value);
          }
        };

        // 輔助複製任意內容到剪貼簿，並以訊息提示複製結果。
        const copyContent = async (value, label = '內容') => {
          try {
            const text = typeof value === 'string' ? value : JSON.stringify(value, null, 2);
            if (!navigator.clipboard) {
              throw new Error('瀏覽器不支援自動複製，請手動複製內容。');
            }
            await navigator.clipboard.writeText(text);
            showSuccess(`${label}已複製。`);
          } catch (error) {
            const message = error instanceof Error ? error.message : '複製失敗，請手動複製內容。';
            showError(message);
          }
        };

        // 判斷 Swagger security 是否需要權杖，以便提示使用者。
        const hasSecurityRequirement = (security) => {
          if (!Array.isArray(security)) {
            return false;
          }
          return security.some((item) => item && Object.keys(item).length > 0);
        };

        const determineRequiresAuth = (operation, spec) => {
          if (Array.isArray(operation?.security)) {
            if (operation.security.length === 0) {
              return false;
            }
            return hasSecurityRequirement(operation.security);
          }
          if (Array.isArray(spec?.security)) {
            return hasSecurityRequirement(spec.security);
          }
          return false;
        };

        // 從 Swagger 定義擷取 requestBody 範例，讓測試流程可快速帶入。
        const extractRequestExample = (operation) => {
          const requestBody = operation?.requestBody;
          if (!requestBody || !requestBody.content) {
            return null;
          }
          const content = requestBody.content;
          const jsonMedia = content['application/json']
            ?? content['application/*+json']
            ?? Object.values(content)[0];
          if (!jsonMedia) {
            return null;
          }
          if (jsonMedia.example) {
            return jsonMedia.example;
          }
          if (jsonMedia.examples) {
            const firstExample = Object.values(jsonMedia.examples).find((item) => item && item.value !== undefined);
            if (firstExample && firstExample.value !== undefined) {
              return firstExample.value;
            }
          }
          if (jsonMedia.schema && jsonMedia.schema.example !== undefined) {
            return jsonMedia.schema.example;
          }
          return null;
        };

        // 依據 Swagger 定義組合出官方 UI 測試連結，方便切換至 Swagger 試用。
        const buildSwaggerUiLink = (specUrl, tag, operationId) => {
          if (!specUrl || !tag || !operationId) {
            return '';
          }
          try {
            const url = new URL(specUrl, window.location.origin);
            const pathSegments = url.pathname.split('/');
            const swaggerIndex = pathSegments.findIndex((segment) => segment.toLowerCase() === 'swagger');
            if (swaggerIndex === -1) {
              return '';
            }
            url.pathname = `${pathSegments.slice(0, swaggerIndex + 1).join('/')}/index.html`;
            url.search = '';
            url.hash = `#/${encodeURIComponent(tag)}/${encodeURIComponent(operationId)}`;
            return url.toString();
          } catch (error) {
            console.warn('建立 Swagger UI 連結時發生錯誤：', error);
            return '';
          }
        };

        // 將 Swagger 解析為群組結構，供操作列表直接渲染。
        const createDynamicGroups = (spec, specUrl) => {
          const paths = spec?.paths ?? {};
          const operations = [];
          Object.entries(paths).forEach(([pathKey, methods]) => {
            Object.entries(methods).forEach(([methodKey, operation]) => {
              if (!operation || typeof operation !== 'object') {
                return;
              }
              const method = methodKey.toUpperCase();
              const tags = Array.isArray(operation.tags) && operation.tags.length ? operation.tags : ['未分組'];
              const operationId = operation.operationId?.trim() || `${method}_${pathKey.replace(/[^a-zA-Z0-9]/g, '_')}`;
              const displayName = operation.summary?.trim() || `${method} ${pathKey}`;
              operations.push({
                displayName,
                name: displayName,
                method,
                path: pathKey,
                description: operation.description || '',
                requiresAuth: determineRequiresAuth(operation, spec),
                template: extractRequestExample(operation),
                tags,
                swaggerLink: buildSwaggerUiLink(specUrl, tags[0], operationId),
                operationId
              });
            });
          });

          const groupMap = new Map();
          operations.forEach((operation) => {
            operation.tags.forEach((tag) => {
              if (!groupMap.has(tag)) {
                groupMap.set(tag, []);
              }
              groupMap.get(tag).push(operation);
            });
          });

          return Array.from(groupMap.entries())
            .map(([tag, ops]) => ({
              name: `Swagger｜${tag}`,
              operations: ops
            }))
            .sort((a, b) => a.name.localeCompare(b.name));
        };

        const appendLog = (entry) => {
          logs.value.unshift({
            id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
            timestamp: new Date(),
            ...entry
          });
        };

        const performRequest = async ({ method, path, body, includeAuth = true, contentType = 'application/json', formData, description, captureSummary = false }) => {
          const url = composeUrl(path);
          const headers = new Headers();

          if (includeAuth && authState.accessToken) {
            headers.set('Authorization', `Bearer ${authState.accessToken}`);
          }

          let requestBody;
          let requestSummary;

          if (contentType === 'application/json') {
            headers.set('Content-Type', 'application/json');
            if (body && method.toUpperCase() !== 'GET' && method.toUpperCase() !== 'HEAD') {
              if (typeof body === 'string') {
                requestBody = body;
              } else {
                requestBody = JSON.stringify(body);
              }
            }
            requestSummary = requestBody;
          } else if (contentType === 'multipart/form-data') {
            requestBody = formData;
            if (formData) {
              requestSummary = Array.from(formData.entries()).reduce((acc, [key, value]) => {
                const displayValue = value instanceof File ? `檔案：${value.name}` : value;
                acc[key] = displayValue;
                return acc;
              }, {});
            }
          }

          let response;
          let responseText = '';
          let responseData = null;
          let responseSummary = null;
          let isJson = false;

          try {
            response = await fetch(url, {
              method,
              headers,
              body: requestBody
            });

            responseText = await response.text();
            if (responseText) {
              try {
                responseData = JSON.parse(responseText);
                isJson = true;
              } catch (error) {
                responseData = responseText;
              }
            }

            responseSummary = {
              status: `${response.status} ${response.statusText}`,
              headers: Object.fromEntries(response.headers.entries()),
              body: responseData
            };

            if (!response.ok) {
              const errorMessage = isJson && responseData?.detail
                ? responseData.detail
                : `請求失敗，狀態碼：${response.status}`;
              throw new Error(errorMessage);
            }

            appendLog({
              title: description ?? '自訂請求',
              request: {
                url,
                method,
                headers: Object.fromEntries(headers.entries()),
                body: requestSummary ?? null
              },
              response: responseSummary,
              isError: false
            });

            if (captureSummary) {
              // 將回應摘要包裝回傳，供需要即時顯示結果的流程（例如自訂請求）使用
              return {
                data: responseData,
                summary: responseSummary
              };
            }

            return responseData;
          } catch (error) {
            const fallbackResponse = responseSummary ?? {
              status: response ? `${response.status} ${response.statusText}` : '未送達',
              headers: response ? Object.fromEntries(response.headers.entries()) : {},
              body: responseText || (error instanceof Error ? error.message : String(error))
            };

            appendLog({
              title: description ?? '自訂請求',
              request: {
                url,
                method,
                headers: Object.fromEntries(headers.entries()),
                body: requestSummary ?? null
              },
              response: fallbackResponse,
              isError: true,
              errorMessage: error instanceof Error ? error.message : '未知錯誤'
            });
            const normalizedError = error instanceof Error ? error : new Error(String(error));
            if (captureSummary) {
              // 將錯誤時的回應摘要綁定在錯誤物件上，讓呼叫端可以顯示詳細內容
              normalizedError.summary = fallbackResponse;
            }
            throw normalizedError;
          }
        };

        const prefillOperation = (operation) => {
          requestForm.method = operation.method;
          requestForm.path = operation.path;
          requestForm.useAuth = operation.requiresAuth ?? true;
          if (operation.method === 'GET') {
            requestForm.body = '';
            return;
          }
          if (operation.template) {
            requestForm.body = typeof operation.template === 'string'
              ? operation.template
              : JSON.stringify(operation.template, null, 2);
          } else {
            requestForm.body = '';
          }
        };

        const customRequestState = reactive({
          // summary 儲存 performRequest 回傳的 HTTP 狀態、標頭與 body，提供畫面顯示
          summary: null,
          // success 標記本次呼叫是否成功，以決定顯示對應樣式
          success: null,
          // message 顯示給使用者的說明，搭配提示訊息呈現
          message: '',
          // updatedAt 保留最新結果時間，顯示在畫面上協助追蹤
          updatedAt: null
        });

        const sendCustomRequest = async () => {
          requestLoading.value = true;
          try {
            const body = requestForm.body && requestForm.method !== 'GET'
              ? requestForm.body
              : undefined;
            const { data, summary } = await performRequest({
              method: requestForm.method,
              path: requestForm.path,
              body,
              includeAuth: requestForm.useAuth,
              contentType: 'application/json',
              description: '自訂請求',
              captureSummary: true
            });
            customRequestState.summary = summary;
            customRequestState.success = true;
            customRequestState.message = '請求已送出並完成。';
            customRequestState.updatedAt = new Date();
            showSuccess('請求已送出並完成。');
            return data;
          } catch (error) {
            const message = error instanceof Error ? error.message : '請求失敗，請稍後再試。';
            const fallback = error && typeof error === 'object' && 'summary' in error
              ? error.summary
              : {
                  status: '未送達',
                  headers: {},
                  body: message
                };
            customRequestState.summary = fallback;
            customRequestState.success = false;
            customRequestState.message = message;
            customRequestState.updatedAt = new Date();
            showError(message);
          } finally {
            requestLoading.value = false;
          }
        };

        const login = async () => {
          loginLoading.value = true;
          try {
            const payload = { deviceKey: authState.deviceKey };
            const response = await performRequest({
              method: 'POST',
              path: '/auth/login',
              body: JSON.stringify(payload),
              includeAuth: false,
              description: '登入取得權杖'
            });
            if (response) {
              authState.accessToken = response.accessToken ?? '';
              authState.refreshToken = response.refreshToken ?? '';
              showSuccess('登入成功，權杖已更新。');
            }
          } catch (error) {
            showError(error.message || '登入失敗，請確認裝置機碼。');
          } finally {
            loginLoading.value = false;
          }
        };

        const refreshToken = async () => {
          if (!authState.refreshToken) {
            showError('請先登入以取得 Refresh Token。');
            return;
          }
          refreshLoading.value = true;
          try {
            const payload = {
              refreshToken: authState.refreshToken,
              deviceKey: authState.deviceKey
            };
            const response = await performRequest({
              method: 'POST',
              path: '/auth/token/refresh',
              body: JSON.stringify(payload),
              includeAuth: false,
              description: '刷新權杖'
            });
            if (response) {
              authState.accessToken = response.accessToken ?? '';
              authState.refreshToken = response.refreshToken ?? authState.refreshToken;
              showSuccess('已重新取得 Access Token。');
            }
          } catch (error) {
            showError(error.message || '刷新權杖失敗，請重新登入。');
          } finally {
            refreshLoading.value = false;
          }
        };

        const fetchUserInfo = async () => {
          if (!authState.accessToken) {
            showError('請先登入以取得 Access Token。');
            return;
          }
          infoLoading.value = true;
          try {
            const response = await performRequest({
              method: 'GET',
              path: '/auth/info',
              includeAuth: true,
              description: '取得登入者資訊'
            });
            if (response) {
              elementPlus.ElMessageBox.alert(formatJson(response), '登入者資訊', {
                confirmButtonText: '了解'
              });
            }
          } catch (error) {
            showError(error.message || '查詢登入資訊失敗。');
          } finally {
            infoLoading.value = false;
          }
        };

        const sendCarPlateRecognition = async () => {
          if (!authState.accessToken) {
            showError('請先登入以取得 Access Token。');
            return;
          }

          if (!carPlateForm.imageBase64 && carPlateForm.fileList.length === 0) {
            showError('請提供車牌照片或 Base64 影像字串。');
            return;
          }

          carPlateForm.loading = true;
          try {
            const formData = new FormData();
            if (carPlateForm.fileList.length > 0 && carPlateForm.fileList[0].raw) {
              formData.append('image', carPlateForm.fileList[0].raw);
            }
            if (carPlateForm.imageBase64.trim().length > 0) {
              formData.append('imageBase64', carPlateForm.imageBase64.trim());
            }

            const response = await performRequest({
              method: 'POST',
              path: '/car-plates/recognitions',
              includeAuth: true,
              contentType: 'multipart/form-data',
              formData,
              description: '車牌辨識'
            });
            carPlateForm.result = response;
            showSuccess('車牌辨識請求完成。');
          } catch (error) {
            showError(error.message || '車牌辨識失敗，請稍後再試。');
          } finally {
            carPlateForm.loading = false;
          }
        };

        const searchCarPlateHistory = async () => {
          if (!authState.accessToken) {
            showError('請先登入以取得 Access Token。');
            return;
          }

          if (!carPlateSearchForm.carPlateNumber) {
            showError('請輸入欲查詢的車牌號碼。');
            return;
          }

          carPlateSearchForm.loading = true;
          try {
            const payload = {
              carPlateNumber: carPlateSearchForm.carPlateNumber
            };
            const response = await performRequest({
              method: 'POST',
              path: '/car-plates/search',
              body: JSON.stringify(payload),
              includeAuth: true,
              description: '車牌維修紀錄查詢'
            });
            carPlateSearchForm.result = response;
            showSuccess('查詢成功。');
          } catch (error) {
            showError(error.message || '查無維修紀錄或查詢失敗。');
          } finally {
            carPlateSearchForm.loading = false;
          }
        };

        const uploadPhoto = async () => {
          if (!authState.accessToken) {
            showError('請先登入以取得 Access Token。');
            return;
          }

          if (photoUploadForm.fileList.length === 0 || !photoUploadForm.fileList[0].raw) {
            showError('請選擇欲上傳的圖片。');
            return;
          }

          photoUploadForm.loading = true;
          try {
            const formData = new FormData();
            formData.append('file', photoUploadForm.fileList[0].raw);
            const response = await performRequest({
              method: 'POST',
              path: '/photos',
              includeAuth: true,
              contentType: 'multipart/form-data',
              formData,
              description: '圖片上傳'
            });
            photoUploadForm.result = response;
            showSuccess('圖片上傳完成。');
          } catch (error) {
            showError(error.message || '圖片上傳失敗。');
          } finally {
            photoUploadForm.loading = false;
          }
        };

        const clearTokens = () => {
          authState.accessToken = '';
          authState.refreshToken = '';
          showSuccess('已清除權杖。');
        };

        const clearLogs = () => {
          logs.value = [];
          showSuccess('已清除呼叫紀錄。');
        };

        const handleCarPlateFileChange = (uploadFile, uploadFiles) => {
          carPlateForm.fileList = uploadFiles.slice(-1);
        };

        const handleCarPlateFileRemove = () => {
          carPlateForm.fileList = [];
        };

        const handlePhotoFileChange = (uploadFile, uploadFiles) => {
          photoUploadForm.fileList = uploadFiles.slice(-1);
        };

        const handlePhotoFileRemove = () => {
          photoUploadForm.fileList = [];
        };

        const formatTimestamp = (timestamp) => {
          return new Intl.DateTimeFormat('zh-TW', {
            hour12: false,
            dateStyle: 'short',
            timeStyle: 'medium'
          }).format(timestamp);
        };

        // ---------- API 快速帶入靜態範本 ----------
        // 依據 API 文件整理常用端點，協助在無 Swagger 定義時依舊能快速組裝請求。
        const staticOperationGroups = [
          {
            name: '常用｜授權與維運',
            operations: [
              {
                name: '登入取得權杖',
                method: 'POST',
                path: '/auth/login',
                template: {
                  deviceKey: 'CFC29A95-885C-CF45-A91C-F0DD3F1DDD7C'
                },
                requiresAuth: false,
                description: '以裝置機碼取得 Access/Refresh Token。'
              },
              {
                name: '刷新 Access Token',
                method: 'POST',
                path: '/auth/token/refresh',
                template: {
                  refreshToken: '<請填入現有 Refresh Token>',
                  deviceKey: 'CFC29A95-885C-CF45-A91C-F0DD3F1DDD7C'
                },
                requiresAuth: false,
                description: '使用 Refresh Token 重新取得 Access Token。'
              },
              {
                name: '取得登入者資訊',
                method: 'GET',
                path: '/auth/info',
                requiresAuth: true,
                description: '查詢目前登入者的顯示名稱與角色。'
              },
              {
                name: '建立後台帳號與裝置',
                method: 'POST',
                path: '/admin/accounts',
                template: {
                  displayName: '陳大明',
                  role: 'StoreManager',
                  deviceKey: 'CFC29A95-885C-CF45-A91C-F0DD3F1DDD7C',
                  deviceName: '高雄總店平板',
                  operatorName: 'SystemAdmin'
                },
                requiresAuth: true,
                description: '建立管理者帳號並綁定登入裝置。'
              },
              {
                name: '健康檢查',
                method: 'GET',
                path: '/healthcheck',
                requiresAuth: false,
                description: '確認服務是否運作中（免權杖）。'
              }
            ]
          },
          {
            name: '基礎資料｜品牌、門市與技師',
            operations: [
              {
                name: '品牌列表 (分頁)',
                method: 'GET',
                path: '/brands?page=1&pageSize=20',
                requiresAuth: true,
                description: '示範以 Query 參數取得品牌清單並套用分頁。'
              },
              {
                name: '服務類別列表 (分頁)',
                method: 'GET',
                path: '/service-categories?page=1&pageSize=20',
                requiresAuth: true,
                description: '列出服務類別主檔，支援指定頁碼與每頁筆數。'
              },
              {
                name: '門市列表 (分頁)',
                method: 'GET',
                path: '/stores?page=1&pageSize=20',
                requiresAuth: true,
                description: '取得門市清單，適合搭配技師查詢或門市維運。'
              },
              {
                name: '品牌與型號清單',
                method: 'GET',
                path: '/brands-models',
                requiresAuth: true,
                description: '取得品牌與車型樹狀資料供下拉選單使用。'
              },
              {
                name: '技師名單 (登入門市)',
                method: 'GET',
                path: '/technicians?page=1&pageSize=20',
                requiresAuth: true,
                description: '依登入者所屬門市列出技師清單，支援分頁查詢。'
              },
              {
                name: '技師名單 (指定門市)',
                method: 'GET',
                path: '/technicians/St_SAMPLE_UID?page=1&pageSize=20',
                requiresAuth: true,
                description: '提供管理者依門市 UID 交叉查詢技師人員。'
              }
            ]
          },
          {
            name: '車牌模組',
            operations: [
              {
                name: '車牌影像辨識',
                method: 'POST',
                path: '/car-plates/recognitions',
                template: {
                  imageBase64: 'data:image/jpeg;base64,<貼上影像編碼>'
                },
                requiresAuth: true,
                description: '支援檔案或 Base64，本範例示範以 Base64 字串送出辨識。'
              },
              {
                name: '車牌維修紀錄查詢',
                method: 'POST',
                path: '/car-plates/search',
                template: {
                  carPlateNumber: 'AAA-1234'
                },
                requiresAuth: true,
                description: '依車牌號碼取得歷史估價與維修紀錄。'
              }
            ]
          },
          {
            name: '客戶模組',
            operations: [
              {
                name: '客戶列表 (分頁)',
                method: 'GET',
                path: '/customers?page=1&pageSize=20',
                requiresAuth: true,
                description: '快速取得客戶列表並驗證分頁資訊。'
              },
              {
                name: '新增客戶',
                method: 'POST',
                path: '/customers',
                template: {
                  customerName: '林小華',
                  phone: '0988123456',
                  category: '一般客戶',
                  gender: 'Male',
                  county: '高雄市',
                  township: '左營區',
                  email: 'demo@dentstage.com',
                  source: 'Facebook',
                  reason: '想了解凹痕修復方案',
                  remark: '首次到店，請協助安排體驗'
                },
                requiresAuth: true,
                description: '建立客戶主檔，欄位與後端驗證相符。'
              },
              {
                name: '編輯客戶',
                method: 'POST',
                path: '/customers/edit',
                template: {
                  customerUid: 'Cu_1B65002E-EEC5-42FA-BBBB-6F5E4708610A',
                  customerName: '林小華',
                  phone: '0988123456',
                  category: '一般客戶',
                  gender: 'Male',
                  county: '高雄市',
                  township: '左營區',
                  email: 'demo@dentstage.com',
                  source: 'Facebook',
                  reason: '想了解凹痕修復方案',
                  remark: '首次到店，請協助安排體驗'
                },
                requiresAuth: true,
                description: '更新既有客戶資料，需帶入 customerUid。'
              },
              {
                name: '電話搜尋客戶',
                method: 'POST',
                path: '/customers/phone-search',
                template: {
                  phone: '0988123456'
                },
                requiresAuth: true,
                description: '依電話查詢客戶資料與維修次數統計。'
              }
            ]
          },
          {
            name: '車輛模組',
            operations: [
              {
                name: '車輛列表 (分頁)',
                method: 'GET',
                path: '/cars?page=1&pageSize=20',
                requiresAuth: true,
                description: '取得車輛清單並檢視分頁資訊。'
              },
              {
                name: '新增車輛',
                method: 'POST',
                path: '/cars',
                template: {
                  carPlateNumber: 'AAA-1234',
                  brandUid: 'B_C7CAB67F-9F5A-11F0-A812-000C2990DEAF',
                  modelUid: 'M_E706D04B-9F5A-11F0-A812-000C2990DEAF',
                  color: '白色',
                  mileage: 15800,
                  remark: '建立車輛測試資料'
                },
                requiresAuth: true,
                description: '新增車輛主檔，需搭配品牌與型號 UID。'
              },
              {
                name: '編輯車輛',
                method: 'POST',
                path: '/cars/edit',
                template: {
                  carUid: 'Ca_00D20FB3-E0D1-440A-93C4-4F62AB511C2D',
                  carPlateNumber: 'AAA-5678',
                  brandUid: 'B_C7CAB67F-9F5A-11F0-A812-000C2990DEAF',
                  modelUid: 'M_E706D04B-9F5A-11F0-A812-000C2990DEAF',
                  color: '黑色',
                  mileage: 18500,
                  remark: '客戶更換車色為黑'
                },
                requiresAuth: true,
                description: '更新既有車輛資料，需帶入 carUid。'
              }
            ]
          },
          {
            name: '估價單模組',
            operations: [
              {
                name: '估價單列表 (GET)',
                method: 'GET',
                path: '/quotations?status=110&page=1&pageSize=20',
                requiresAuth: true,
                description: '以查詢參數取得估價單列表，預設查詢估價中資料。'
              },
              {
                name: '估價單列表 (POST)',
                method: 'POST',
                path: '/quotations',
                template: {
                  fixType: 'F_DENT_SAMPLE',
                  status: '110',
                  startDate: '2024-03-01T00:00:00',
                  endDate: '2024-03-31T23:59:59',
                  customerKeyword: '林',
                  carPlateKeyword: 'AAA',
                  page: 1,
                  pageSize: 20
                },
                requiresAuth: true,
                description: '透過 Body 傳遞查詢條件，欄位對應 QuotationListQuery。'
              },
              {
                name: '新增估價單',
                method: 'POST',
                path: '/quotations/create',
                template: {
                  store: {
                    estimationTechnicianUid: 'U_054C053D-FBA6-D843-9BDA-8C68E5027895',
                    creatorTechnicianUid: 'U_054C053D-FBA6-D843-9BDA-8C68E5027895',
                    source: '官方網站',
                    bookMethod: 'LINE 預約',
                    reservationDate: '2024-10-15T10:00:00',
                    repairDate: '2024-10-25T09:00:00'
                  },
                  car: {
                    carUid: 'Ca_00D20FB3-E0D1-440A-93C4-4F62AB511C2D',
                    mileage: 18500
                  },
                  customer: {
                    customerUid: 'Cu_1B65002E-EEC5-42FA-BBBB-6F5E4708610A',
                  },
                  damages: {
                    dent: [
                      {
                        photos: 'Ph_759F19C7-5D62-4DB2-8021-2371C3136F7B',
                        position: '前保桿',
                        dentStatus: '大面積',
                        description: '需板金搭配烤漆',
                        estimatedAmount: 4500,
                        fixType: '凹痕'
                      }
                    ],
                    paint: [
                      {
                        photos: 'Ph_1F8AC157-5AC2-4E9C-9E0C-A5E8B4C8F3B0',
                        position: '右後葉子板',
                        dentStatus: '烤漆',
                        description: '刮傷需補土烤漆',
                        estimatedAmount: 3200,
                        fixType: '板烤/鈑烤'
                      }
                    ]
                  },
                  maintenance: {
                    fixType: '凹痕',
                    reserveCar: true,
                    estimatedRepairDays: 1,
                    estimatedRepairHours: 6,
                    estimatedRestorationPercentage: 90,
                    remark: '請於修復後通知客戶取車'
                  }
                },
                requiresAuth: true,
                description: '建立估價單，需先準備車輛、客戶與維修設定。'
              },
              {
                name: '估價單詳情',
                method: 'POST',
                path: '/quotations/detail',
                template: {
                  quotationNo: 'Q25100001'
                },
                requiresAuth: true,
                description: '依估價單編號取得完整內容。'
              },
              {
                name: '編輯估價單',
                method: 'POST',
                path: '/quotations/edit',
                template: {
                  quotationNo: 'Q25100001',
                  store: {
                    estimationTechnicianUid: 'U_054C053D-FBA6-D843-9BDA-8C68E5027895',
                    creatorTechnicianUid: 'U_054C053D-FBA6-D843-9BDA-8C68E5027895',
                    source: '官方網站',
                    bookMethod: 'LINE 預約',
                    reservationDate: '2024-10-15T10:00:00',
                    repairDate: '2024-10-25T09:00:00'
                  },
                  car: {
                    carUid: 'Ca_00D20FB3-E0D1-440A-93C4-4F62AB511C2D',
                    mileage: 18500
                  },
                  customer: {
                    customerUid: 'Cu_1B65002E-EEC5-42FA-BBBB-6F5E4708610A',
                  },
                  damages: {
                    dent: [
                      {
                        photos: 'Ph_759F19C7-5D62-4DB2-8021-2371C3136F7B',
                        position: '前保桿',
                        dentStatus: '大面積',
                        description: '需板金搭配烤漆',
                        estimatedAmount: 4500,
                        fixType: '凹痕'
                      }
                    ],
                    beauty: [
                      {
                        photos: 'Ph_A67C6B52-A09F-4C7D-B1F1-9CDA3B67E2C5',
                        position: '內裝皮革',
                        dentStatus: '美容拋光',
                        description: '座椅刮痕需要美容處理',
                        estimatedAmount: 1500,
                        fixType: '美容'
                      }
                    ]
                  },
                  carBodyConfirmation: {
                    signaturePhotoUid: 'Ph_D4FB9159-CD9E-473A-A3D9-0A8FDD0B76F8',
                    damageMarkers: [
                      {
                        x: 0.42,
                        y: 0.63,
                        hasDent: true,
                        hasScratch: false,
                        hasPaintPeel: false,
                        remark: '主要凹痕'
                      }
                    ]
                  },
                  maintenance: {
                    fixType: 'beauty',
                    reserveCar: true,
                    applyCoating: false,
                    applyWrapping: false,
                    hasRepainted: false,
                    needToolEvaluation: true,
                    otherFee: 800,
                    roundingDiscount: 200,
                    percentageDiscount: 10,
                    discountReason: '回饋老客戶',
                    estimatedRepairDays: 1,
                    estimatedRepairHours: 6,
                    estimatedRestorationPercentage: 90,
                    suggestedPaintReason: null,
                    unrepairableReason: null,
                    remark: '請於修復後通知客戶取車'
                  }
                },
                requiresAuth: true,
                description: '沿用估價單詳情欄位編輯，建議共用維修單表單。'
              },
              {
                name: '估價完成',
                method: 'POST',
                path: '/quotations/evaluate',
                template: {
                  quotationNo: 'Q25100001'
                },
                requiresAuth: true,
                description: '將狀態更新為估價完成 (180)。'
              },
              {
                name: '取消估價/預約',
                method: 'POST',
                path: '/quotations/cancel',
                template: {
                  quotationNo: 'Q25100001',
                  reason: '客戶取消到店',
                  clearReservation: true
                },
                requiresAuth: true,
                description: '取消估價或預約，可選擇是否清除預約日期。'
              },
              {
                name: '轉預約或設定日期',
                method: 'POST',
                path: '/quotations/reserve',
                template: {
                  quotationNo: 'Q25100001',
                  reservationDate: '2024-10-20T10:00:00'
                },
                requiresAuth: true,
                description: '設定預約日期，將狀態轉為預約中。'
              },
              {
                name: '更新預約日期',
                method: 'POST',
                path: '/quotations/reserve/update',
                template: {
                  quotationNo: 'Q25100001',
                  reservationDate: '2024-10-28T09:30:00'
                },
                requiresAuth: true,
                description: '異動既有預約日期。'
              },
              {
                name: '取消預約',
                method: 'POST',
                path: '/quotations/reserve/cancel',
                template: {
                  quotationNo: 'Q25100001',
                  reason: '客戶延期',
                  clearReservation: true
                },
                requiresAuth: true,
                description: '取消預約並視需求清除預約日期。'
              },
              {
                name: '估價狀態回溯',
                method: 'POST',
                path: '/quotations/revert',
                template: {
                  quotationNo: 'Q25100001'
                },
                requiresAuth: true,
                description: '將估價單狀態回復上一階段（依序 195 → 191 → 190 → 180 → 110）。'
              },
              {
                name: '估價轉維修',
                method: 'POST',
                path: '/quotations/maintenance',
                template: {
                  quotationNo: 'Q25100001'
                },
                requiresAuth: true,
                description: '將估價單轉為維修單並產生維修編號。'
              }
            ]
          },
          {
            name: '維修單模組',
            operations: [
              {
                name: '維修單列表 (GET)',
                method: 'GET',
                path: '/maintenance-orders?status=210&page=1&pageSize=20',
                requiresAuth: true,
                description: '以查詢參數取得維修單列表，預設查詢待確認資料，回應中可看到 estimationTechnicianUid 與 creatorTechnicianUid。'
              },
              {
                name: '維修單列表 (POST)',
                method: 'POST',
                path: '/maintenance-orders',
                template: {
                  status: '220',
                  startDate: '2024-03-01T00:00:00',
                  endDate: '2024-03-31T23:59:59',
                  page: 1,
                  pageSize: 20
                },
                requiresAuth: true,
                description: '透過 Body 查詢維修單，欄位對應 MaintenanceOrderListQuery。'
              },
              {
                name: '維修單詳情',
                method: 'POST',
                path: '/maintenance-orders/detail',
                template: {
                  orderNo: 'O25100001'
                },
                requiresAuth: true,
                description: '依維修單編號取得詳細資料，store 區塊會同步帶出 estimationTechnicianUid 與 creatorTechnicianUid。'
              },
              {
                name: '維修單回溯',
                method: 'POST',
                path: '/maintenance-orders/revert',
                template: {
                  orderNo: 'O25100001'
                },
                requiresAuth: true,
                description: '誤按狀態時回復上一階段（依序 295 → 290 → 220 → 210）。'
              },
              {
                name: '確認維修開始',
                method: 'POST',
                path: '/maintenance-orders/confirm',
                template: {
                  orderNo: 'O25100001'
                },
                requiresAuth: true,
                description: '更新狀態為維修中。'
              },
              {
                name: '編輯維修單',
                method: 'POST',
                path: '/maintenance-orders/edit',
                template: {
                  quotationNo: 'Q25100001',
                  orderNo: 'O25100001',
                  store: {
                    estimationTechnicianUid: 'U_054C053D-FBA6-D843-9BDA-8C68E5027895',
                    creatorTechnicianUid: 'U_054C053D-FBA6-D843-9BDA-8C68E5027895',
                    source: '官方網站',
                    reservationDate: '2024-10-15T10:00:00',
                    repairDate: '2024-10-25T09:00:00'
                  },
                  car: {
                    carUid: 'Ca_00D20FB3-E0D1-440A-93C4-4F62AB511C2D'
                  },
                  customer: {
                    customerUid: 'Cu_1B65002E-EEC5-42FA-BBBB-6F5E4708610A'
                  },
                  damages: {
                    dent: [
                      {
                        photos: 'Ph_759F19C7-5D62-4DB2-8021-2371C3136F7B',
                        position: '前保桿',
                        dentStatus: '大面積',
                        description: '需板金搭配烤漆',
                        estimatedAmount: 4500,
                        fixType: '凹痕'
                      }
                    ],
                    other: [
                      {
                        photos: 'Ph_2B71AFAE-4F9E-4E60-9AD5-16F1C927A2C8',
                        position: '保桿內塑料件',
                        dentStatus: '拆件檢測',
                        description: '需確認內部樑是否受損',
                        estimatedAmount: 1200,
                        fixType: '其他'
                      }
                    ]
                  },
                  carBodyConfirmation: {
                    signaturePhotoUid: 'Ph_D4FB9159-CD9E-473A-A3D9-0A8FDD0B76F8',
                    damageMarkers: [
                      {
                        x: 0.42,
                        y: 0.63,
                        hasDent: true,
                        hasScratch: false,
                        hasPaintPeel: false,
                        remark: '主要凹痕'
                      }
                    ]
                  },
                  maintenance: {
                    fixType: '其他',
                    reserveCar: true,
                    applyCoating: false,
                    applyWrapping: false,
                    hasRepainted: false,
                    needToolEvaluation: true,
                    otherFee: 800,
                    roundingDiscount: 200,
                    percentageDiscount: 10,
                    discountReason: '回饋老客戶',
                    estimatedRepairDays: 1,
                    estimatedRepairHours: 6,
                    estimatedRestorationPercentage: 90,
                    suggestedPaintReason: null,
                    unrepairableReason: null,
                    remark: '請於修復後通知客戶取車'
                  }
                },
                requiresAuth: true,
                description: '沿用估價單編輯完整結構同步車輛、客戶、傷痕、車體確認與維修設定。'
              },
              {
                name: '續修維修單',
                method: 'POST',
                path: '/maintenance-orders/continue',
                template: {
                  orderNo: 'O25100001'
                },
                requiresAuth: true,
                description: '複製估價單與相關圖片，並將原維修單標記為取消維修。'
              },
              {
                name: '維修完成',
                method: 'POST',
                path: '/maintenance-orders/complete',
                template: {
                  orderNo: 'O25100001'
                },
                requiresAuth: true,
                description: '將維修單狀態更新為完成 (290) 並記錄操作人。'
              },
              {
                name: '終止維修',
                method: 'POST',
                path: '/maintenance-orders/terminate',
                template: {
                  orderNo: 'O25100001'
                },
                requiresAuth: true,
                description: '將維修單狀態更新為終止 (295)，同時保留追蹤紀錄。'
              }
            ]
          },
          {
            name: '圖片模組',
            operations: [
              {
                name: '上傳維修/估價照片',
                method: 'POST',
                path: '/photos',
                requiresAuth: true,
                description: '需使用下方「圖片上傳測試」卡片送出 multipart/form-data。'
              },
              {
                name: '下載圖片',
                method: 'GET',
                path: '/photos/{photoUid}',
                requiresAuth: true,
                description: '以取得的 photoUid 下載原始影像。'
              }
            ]
          }
        ];

        // 將操作資訊統一格式，確保後續篩選時欄位完整。
        const normalizeGroupOperations = (group) => ({
          name: group.name,
          operations: group.operations.map((operation) => ({
            ...operation,
            displayName: operation.displayName || operation.name || `${operation.method} ${operation.path}`,
            description: operation.description || '',
            requiresAuth: operation.requiresAuth ?? true,
            swaggerLink: operation.swaggerLink || ''
          }))
        });

        // 依關鍵字篩選群組內的操作，降低大量 API 時的搜尋成本。
        const filterGroupsByKeyword = (groups, keyword) => {
          if (!keyword) {
            return groups;
          }
          const lowered = keyword.toLowerCase();
          return groups
            .map((group) => ({
              name: group.name,
              operations: group.operations.filter((operation) => {
                const combined = [operation.displayName, operation.path, operation.description]
                  .filter(Boolean)
                  .join(' ')
                  .toLowerCase();
                return combined.includes(lowered);
              })
            }))
            .filter((group) => group.operations.length > 0);
        };

        const operationGroups = computed(() => {
          const keyword = operationKeyword.value.trim();
          const normalizedDynamic = dynamicOperationGroups.value.map(normalizeGroupOperations);
          const normalizedStatic = staticOperationGroups.map(normalizeGroupOperations);
          const combined = [...normalizedDynamic, ...normalizedStatic];
          return filterGroupsByKeyword(combined, keyword);
        });

        const swaggerOperationCount = computed(() =>
          dynamicOperationGroups.value.reduce((total, group) => total + group.operations.length, 0)
        );

        const totalVisibleOperations = computed(() =>
          operationGroups.value.reduce((total, group) => total + group.operations.length, 0)
        );

        const ensureGroupExpanded = (groupName) => {
          if (!groupName) {
            return;
          }
          const current = new Set(activeOperationGroups.value);
          current.add(groupName);
          activeOperationGroups.value = Array.from(current);
        };

        const isOperationMatchByQuery = (operation) => {
          if (!operation || typeof operation !== 'object') {
            return false;
          }
          if (initialOperationId && operation.operationId) {
            if (operation.operationId === initialOperationId) {
              return true;
            }
          }
          if (initialOperationMethod && initialOperationPath) {
            const method = (operation.method || '').toUpperCase();
            if (method === initialOperationMethod && operation.path === initialOperationPath) {
              return true;
            }
          }
          return false;
        };

        const findOperationFromGroups = () => {
          for (const group of operationGroups.value) {
            const matched = group.operations.find(isOperationMatchByQuery);
            if (matched) {
              return { groupName: group.name, operation: matched };
            }
          }
          return null;
        };

        const tryApplyInitialPrefill = () => {
          if (!shouldPrefillFromQuery || hasAppliedInitialPrefill.value) {
            return;
          }
          const result = findOperationFromGroups();
          if (!result) {
            if (initialOperationTag) {
              const fallback = operationGroups.value.find((group) =>
                typeof group.name === 'string' && group.name.includes(initialOperationTag)
              );
              if (fallback) {
                ensureGroupExpanded(fallback.name);
              }
            }
            return;
          }
          prefillOperation(result.operation);
          ensureGroupExpanded(result.groupName);
          // 僅展開並帶入指定 API，維持搜尋欄位為空，避免自動篩選造成其他 API 無法顯示。
          // 使用者若仍需快速定位，可自行輸入關鍵字，保留既有互動行為。
          hasAppliedInitialPrefill.value = true;
          showSuccess('已根據指定的 API 操作自動帶入請求參數。');
        };

        watch(
          () => operationGroups.value,
          () => {
            tryApplyInitialPrefill();
          },
          { deep: true }
        );

        // 讀取 Swagger 定義並轉換為畫面可使用的 API 清單。
        const loadSwaggerOperations = async () => {
          if (!swaggerState.specUrl) {
            showError('請先輸入 Swagger 定義網址。');
            return;
          }
          swaggerState.loading = true;
          swaggerState.error = '';
          try {
            const response = await fetch(swaggerState.specUrl, {
              headers: { Accept: 'application/json' }
            });
            if (!response.ok) {
              throw new Error(`無法載入 Swagger 定義，狀態碼：${response.status}`);
            }
            const spec = await response.json();
            dynamicOperationGroups.value = createDynamicGroups(spec, swaggerState.specUrl);
            swaggerState.lastLoadedAt = new Date();
            showSuccess('Swagger API 列表載入完成。');
            tryApplyInitialPrefill();
          } catch (error) {
            const message = error instanceof Error ? error.message : '載入 Swagger 定義時發生未知錯誤。';
            swaggerState.error = message;
            dynamicOperationGroups.value = [];
            showError(message);
          } finally {
            swaggerState.loading = false;
          }
        };

        // 輔助按鈕：一鍵展開所有群組。
        const expandAllGroups = () => {
          activeOperationGroups.value = operationGroups.value.map((group) => group.name);
        };

        // 輔助按鈕：一鍵收合所有群組。
        const collapseAllGroups = () => {
          activeOperationGroups.value = [];
        };

        watch(
          () => operationGroups.value.map((group) => group.name),
          (names) => {
            if (names.length === 0) {
              activeOperationGroups.value = [];
              return;
            }
            const current = new Set(activeOperationGroups.value.filter((name) => names.includes(name)));
            names.slice(0, 3).forEach((name) => current.add(name));
            activeOperationGroups.value = Array.from(current);
          },
          { immediate: true }
        );

        onMounted(() => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const parsed = JSON.parse(saved);
              if (parsed.baseUrl) {
                baseUrl.value = parsed.baseUrl;
              }
              if (parsed.deviceKey) {
                authState.deviceKey = parsed.deviceKey;
              }
              if (parsed.accessToken) {
                authState.accessToken = parsed.accessToken;
              }
              if (parsed.refreshToken) {
                authState.refreshToken = parsed.refreshToken;
              }
            }
          } catch (error) {
            console.warn('載入設定失敗：', error);
          }
          if (initialSpecUrl) {
            // 若外部已指定 Swagger 路徑，立即觸發載入並帶入對應操作。
            swaggerState.specUrl = initialSpecUrl;
            loadSwaggerOperations();
          } else {
            // 沒有指定 Swagger 來源時，仍嘗試對靜態範本套用帶入邏輯。
            tryApplyInitialPrefill();
          }
        });

        watch(
          () => ({
            baseUrl: baseUrl.value,
            deviceKey: authState.deviceKey,
            accessToken: authState.accessToken,
            refreshToken: authState.refreshToken
          }),
          (value) => {
            try {
              localStorage.setItem(STORAGE_KEY, JSON.stringify(value));
            } catch (error) {
              console.warn('儲存設定失敗：', error);
            }
          },
          { deep: true }
        );

        return {
          baseUrl,
          authState,
          loginLoading,
          refreshLoading,
          infoLoading,
          requestForm,
          requestLoading,
          carPlateForm,
          carPlateSearchForm,
          photoUploadForm,
          logs,
          operationGroups,
          activeOperationGroups,
          operationKeyword,
          swaggerState,
          swaggerOperationCount,
          totalVisibleOperations,
          loadSwaggerOperations,
          expandAllGroups,
          collapseAllGroups,
          handleSpecUrlInput,
          responseViewerState,
          customRequestState,
          formatJson,
          toRawText,
          copyContent,
          formatTimestamp,
          composeUrl,
          prefillOperation,
          sendCustomRequest,
          login,
          refreshToken,
          fetchUserInfo,
          sendCarPlateRecognition,
          searchCarPlateHistory,
          uploadPhoto,
          clearTokens,
          clearLogs,
          handleCarPlateFileChange,
          handleCarPlateFileRemove,
          handlePhotoFileChange,
          handlePhotoFileRemove
        };
      }
    };

    // 安裝 Element Plus 元件庫並套用繁體中文語系，若語系載入失敗則退回預設
    createApp(App)
      .use(elementPlus, { locale: zhTwLocale ?? undefined })
      .mount('#app');
  </script>
</body>
</html>
