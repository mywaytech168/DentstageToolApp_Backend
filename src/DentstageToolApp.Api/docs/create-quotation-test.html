<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>估價單建立測試工具</title>
  <!-- 說明：引用 Element Plus 樣式確保元件渲染一致 -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      background-color: #f5f7fa;
      font-family: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    .page-container {
      max-width: 1200px;
      margin: 0 auto 48px auto;
    }
    .card-spacer {
      margin-top: 16px;
    }
    .textarea {
      font-family: "Fira Code", "Consolas", "Courier New", monospace;
    }
    .section-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    pre.result-viewer {
      background-color: #1e1e1e;
      color: #f8f8f2;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log-message {
      margin-bottom: 4px;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }
    .summary-item {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 6px 16px rgba(31, 45, 61, 0.08);
    }
    .summary-item h4 {
      margin: 0 0 6px 0;
      font-size: 15px;
      color: #1f4f82;
    }
    .summary-item p {
      margin: 0;
      font-size: 13px;
      color: #606266;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- 說明：透過 CDN 載入 Vue 與 Element Plus，避免額外建置流程 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
  <script src="https://unpkg.com/element-plus/dist/locale/zh-tw.min.js"></script>

  <script>
    // 說明：由全域物件取出 Composition API 與 Element Plus，保持靜態頁面可用性
    const { createApp, ref, reactive, computed, watch, onMounted } = Vue;
    const elementPlus = window.ElementPlus;
    const zhTwLocale = window.ElementPlusLocaleZhTw?.default ?? window.ElementPlusLocaleZhTw;

    if (!elementPlus) {
      throw new Error('Element Plus 載入失敗，請檢查網路或 CDN 設定。');
    }

    // ---------- 常數區 ----------
    const STORAGE_KEY = 'dentstage-create-quotation-test-settings';
    const BLANK_IMAGE_BASE64 =
      'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=';
    // 說明：定義四種維修類別鍵值，供後續自動建立與清理照片資料使用
    const PHOTO_CATEGORY_KEYS = ['dent', 'beauty', 'paint', 'other'];
    // 說明：對應顯示文字，讓提示訊息保有中文語意
    const PHOTO_CATEGORY_DISPLAY = {
      dent: '凹痕',
      beauty: '美容',
      paint: '板烤',
      other: '其他'
    };
    // 說明：定義維修折扣的預設分類，固定包含美容欄位以支援舊資料
    const MAINTENANCE_CATEGORY_BASE_KEYS = ['dent', 'beauty', 'paint', 'other'];

    // 說明：建立分類折扣的初始結構，統一維修金額與折扣欄位型別
    const buildCategoryAdjustmentTemplate = (source) => {
      const adjustment = {
        otherFee: 0,
        percentageDiscount: 0,
        discountReason: ''
      };

      if (source && typeof source === 'object') {
        if (typeof source.otherFee === 'number') {
          adjustment.otherFee = source.otherFee;
        }
        if (typeof source.percentageDiscount === 'number') {
          adjustment.percentageDiscount = source.percentageDiscount;
        }
        if (typeof source.discountReason === 'string') {
          adjustment.discountReason = source.discountReason;
        }
      }

      return adjustment;
    };

    const App = {
      // ---------- 模板區 ----------
      template: `
        <el-config-provider namespace="el" :locale="locale">
          <div class="page-container">
            <el-page-header content="估價單建立測試工具" icon=""></el-page-header>

            <el-alert
              title="操作流程提醒"
              type="info"
              show-icon
              :closable="false"
              style="margin-top: 12px;"
              description="依序完成登入、取得測試資料或必要 UID，最後送出估價單建立請求。若環境無現成圖片，可直接點擊上方按鈕建立損傷或簽名專用空白圖片以取得 PhotoUID。"
            />

            <!-- 環境與登入設定 -->
            <el-card class="card-spacer">
              <template #header>
                <span>環境與登入設定</span>
              </template>
              <el-form label-width="140px" label-position="left">
                <el-form-item label="API 基底網址">
                  <el-input v-model="baseUrl" placeholder="例如：https://localhost:7249/api" clearable />
                </el-form-item>
                <el-form-item label="裝置機碼">
                  <el-input v-model="loginForm.deviceKey" placeholder="請輸入登入使用的裝置機碼" clearable />
                </el-form-item>
                <el-form-item>
                  <div class="section-actions">
                    <el-button type="primary" :loading="loading.login" @click="login">登入取得權杖</el-button>
                    <el-button type="success" :disabled="!authState.refreshToken" :loading="loading.refresh" @click="refreshToken">刷新 Access Token</el-button>
                    <el-button type="info" :disabled="!authState.accessToken" @click="fetchUserInfo">取得登入者資訊</el-button>
                    <el-button type="warning" @click="clearTokens">清除權杖</el-button>
                  </div>
                </el-form-item>
                <el-form-item label="Access Token">
                  <el-input v-model="authState.accessToken" type="textarea" :rows="3" readonly />
                </el-form-item>
                <el-form-item label="Refresh Token">
                  <el-input v-model="authState.refreshToken" type="textarea" :rows="2" readonly />
                </el-form-item>
              </el-form>
              <el-descriptions :column="2" border size="small">
                <el-descriptions-item label="顯示名稱">{{ authState.displayName || '尚未登入' }}</el-descriptions-item>
                <el-descriptions-item label="角色">{{ authState.role || '-' }}</el-descriptions-item>
                <el-descriptions-item label="Access Token 到期">{{ formatTimestamp(authState.accessTokenExpireAt) }}</el-descriptions-item>
                <el-descriptions-item label="Refresh Token 到期">{{ formatTimestamp(authState.refreshTokenExpireAt) }}</el-descriptions-item>
                <el-descriptions-item label="裝置狀態">{{ authState.deviceStatus || '-' }}</el-descriptions-item>
                <el-descriptions-item label="系統訊息">{{ authState.message || '-' }}</el-descriptions-item>
              </el-descriptions>
            </el-card>

            <!-- 輔助資料快速帶入 -->
            <el-card class="card-spacer">
              <template #header>
                <span>輔助資料快速帶入</span>
              </template>
              <div class="section-actions">
                <el-button type="primary" :loading="loading.random" :disabled="!hasToken" @click="fetchRandomDraft">
                  取得隨機測試草稿
                </el-button>
                <el-button
                  type="warning"
                  :loading="loading.damagePhoto"
                  :disabled="!hasToken"
                  @click="createDamageBlankPhoto"
                >
                  建立損傷空白圖片取得 PhotoUID
                </el-button>
                <el-button
                  type="success"
                  :loading="loading.signaturePhoto"
                  :disabled="!hasToken"
                  @click="createSignatureBlankPhoto"
                >
                  建立簽名空白圖片取得 PhotoUID
                </el-button>
              </div>
              <el-alert
                v-if="!hasToken"
                type="warning"
                title="請先登入"
                :closable="false"
                show-icon
                description="輔助資料 API 需帶入權杖，請於上方完成登入後再操作。"
                style="margin-bottom: 12px;"
              />
              <div v-if="randomSummary.generatedAt" class="card-spacer">
                <el-divider content-position="left">最新測試草稿</el-divider>
                <p>系統於 {{ formatTimestamp(randomSummary.generatedAt) }} 產生以下資料，已自動套用至下方估價單 JSON。</p>
                <div class="summary-grid">
                  <div class="summary-item" v-if="randomSummary.technician">
                    <h4>技師</h4>
                    <p>UID：{{ randomSummary.technician.uid }}</p>
                    <p>名稱：{{ randomSummary.technician.name }}</p>
                    <p>描述：{{ randomSummary.technician.description || '無' }}</p>
                  </div>
                  <div class="summary-item" v-if="randomSummary.store">
                    <h4>門市</h4>
                    <p>UID：{{ randomSummary.store.uid }}</p>
                    <p>名稱：{{ randomSummary.store.name }}</p>
                    <p>描述：{{ randomSummary.store.description || '無' }}</p>
                  </div>
                  <div class="summary-item" v-if="randomSummary.customer">
                    <h4>客戶</h4>
                    <p>UID：{{ randomSummary.customer.uid }}</p>
                    <p>姓名：{{ randomSummary.customer.name }}</p>
                    <p>描述：{{ randomSummary.customer.description || '無' }}</p>
                  </div>
                  <div class="summary-item" v-if="randomSummary.car">
                    <h4>車輛</h4>
                    <p>UID：{{ randomSummary.car.uid }}</p>
                    <p>名稱：{{ randomSummary.car.name }}</p>
                    <p>描述：{{ randomSummary.car.description || '無' }}</p>
                  </div>
                  <div class="summary-item" v-if="randomSummary.fixType">
                    <h4>維修類型</h4>
                    <p>名稱：{{ randomSummary.fixType }}</p>
                    <p>說明：系統僅提供「凹痕」「美容」「板烤」「其他」四種中文名稱。</p>
                  </div>
                </div>
                <el-alert
                  v-if="randomSummary.notes.length > 0"
                  type="info"
                  show-icon
                  :closable="false"
                  style="margin-top: 12px;"
                >
                  <template #title>系統提示</template>
                  <ul>
                    <li v-for="note in randomSummary.notes" :key="note">{{ note }}</li>
                  </ul>
                </el-alert>
              </div>

              <div class="card-spacer">
                <el-divider content-position="left">最新建立的空白圖片</el-divider>
                <el-form label-width="140px" label-position="left">
                  <el-form-item label="損傷用 PhotoUID">
                    <el-input v-model="damagePhotoUid" placeholder="尚未建立圖片" readonly />
                  </el-form-item>
                  <el-form-item label="簽名用 PhotoUID">
                    <el-input v-model="signaturePhotoUid" placeholder="尚未建立圖片" readonly />
                  </el-form-item>
                </el-form>
                <div class="section-actions" style="margin-top: 12px;">
                  <el-button type="primary" :disabled="!canUseDamagePhoto" @click="appendDamageWithPhoto">
                    帶入損傷資料（使用損傷圖片）
                  </el-button>
                  <el-button type="success" :disabled="!canUseSignaturePhoto" @click="applySignatureWithPhoto">
                    套用簽名照片（使用簽名圖片）
                  </el-button>
                </div>
                <el-alert
                  v-if="canUseDamagePhoto"
                  type="info"
                  :closable="false"
                  show-icon
                  title="損傷資料可重複新增"
                  description="系統會在 photos.dent 陣列末端新增一筆固定範例，並直接將 PhotoUID 寫入 photo 欄位，內容同步包含左前門、需烤漆與估價 4648 等欄位。"
                  style="margin-top: 8px;"
                />
                <el-alert
                  v-if="canUseSignaturePhoto"
                  type="info"
                  :closable="false"
                  show-icon
                  title="簽名僅保留最新圖片"
                  description="簽名欄位僅會維持單一 PhotoUID，重複套用時會直接覆蓋舊資料。"
                  style="margin-top: 8px;"
                />
                <el-alert
                  v-if="!canUseDamagePhoto && !canUseSignaturePhoto"
                  type="info"
                  :closable="false"
                  show-icon
                  title="尚未建立空白圖片"
                  description="請先點擊上方按鈕分別建立損傷或簽名使用的空白圖片，即可快速建立對應欄位。"
                  style="margin-top: 8px;"
                />
              </div>
            </el-card>

            <!-- 建立估價單 -->
            <el-card class="card-spacer">
              <template #header>
                <span>建立估價單</span>
              </template>
              <el-alert
                type="success"
                :closable="false"
                show-icon
                title="操作提醒"
                description="請確認 JSON 內容必填欄位皆已填入有效 UID，尤其是技師、客戶、車輛與維修類型。若使用上方隨機草稿，可直接調整後送出。"
                style="margin-bottom: 16px;"
              />
              <div class="section-actions">
                <el-button type="primary" :loading="loading.create" :disabled="!hasToken" @click="createQuotation">送出建立估價單</el-button>
                <el-button @click="formatRequestJson">格式化 JSON</el-button>
                <el-button @click="copyRequest">複製 JSON</el-button>
                <el-button @click="loadDraftAgain" :disabled="loading.random || !hasToken">重新載入最新草稿</el-button>
              </div>
              <el-input
                v-model="createRequestText"
                type="textarea"
                :rows="22"
                class="textarea"
                placeholder="請輸入 CreateQuotationRequest JSON 內容"
              />
              <div v-if="createResponse" class="card-spacer">
                <el-divider content-position="left">建立結果</el-divider>
                <pre class="result-viewer">{{ createResponse }}</pre>
              </div>
            </el-card>

            <!-- 操作紀錄 -->
            <el-card class="card-spacer">
              <template #header>
                <span>操作紀錄</span>
              </template>
              <div class="section-actions">
                <el-button type="danger" size="small" @click="clearLogs">清除紀錄</el-button>
              </div>
              <el-timeline>
                <el-timeline-item
                  v-for="log in logs"
                  :key="log.id"
                  :timestamp="formatTimestamp(log.time)"
                  :type="log.level"
                  placement="top"
                >
                  <div class="log-message">{{ log.message }}</div>
                  <pre v-if="log.payload" class="result-viewer">{{ log.payload }}</pre>
                </el-timeline-item>
                <el-timeline-item v-if="logs.length === 0" timestamp="" type="info">
                  <div class="log-message">尚未有操作紀錄，請開始進行測試流程。</div>
                </el-timeline-item>
              </el-timeline>
            </el-card>
          </div>
        </el-config-provider>
      `,

      setup() {
        const message = elementPlus.ElMessage;

        // ---------- 狀態區 ----------
        const baseUrl = ref('https://localhost:7249/api');
        const loginForm = reactive({ deviceKey: '' });
        const authState = reactive({
          accessToken: '',
          refreshToken: '',
          displayName: '',
          role: '',
          deviceStatus: '',
          message: '',
          accessTokenExpireAt: '',
          refreshTokenExpireAt: ''
        });
        const loading = reactive({
          login: false,
          refresh: false,
          random: false,
          damagePhoto: false,
          signaturePhoto: false,
          create: false
        });
        const createRequestText = ref(`{
  "store": {
    "estimationTechnicianUid": ""
  },
  "car": {
    "carUid": ""
  },
  "customer": {
    "customerUid": ""
  },
  "photos": {
    "dent": [
      {
        "photo": "",
        "position": "左前門",
        "description": "測試損傷位置",
        "estimatedAmount": 4500
      }
    ]
  }
}`);
        const createResponse = ref('');
        const randomSummary = reactive({
          technician: null,
          store: null,
          customer: null,
          car: null,
          fixType: '',
          notes: [],
          generatedAt: ''
        });
        const damagePhotoUid = ref('');
        const signaturePhotoUid = ref('');
        const logs = ref([]);

        const locale = computed(() => zhTwLocale || undefined);
        const hasToken = computed(() => !!authState.accessToken);
        const canUseDamagePhoto = computed(() => !!damagePhotoUid.value);
        const canUseSignaturePhoto = computed(() => !!signaturePhotoUid.value);

        // ---------- 方法區 ----------

        // 建立 API 路徑的共用函式，避免重複處理斜線
        const buildUrl = (path) => {
          const trimmed = baseUrl.value.replace(/\/$/, '');
          const normalizedPath = path.startsWith('/') ? path : `/${path}`;
          return `${trimmed}${normalizedPath}`;
        };

        // 將資料寫入 localStorage，方便下次載入保留環境設定
        const persistSettings = () => {
          const payload = {
            baseUrl: baseUrl.value,
            deviceKey: loginForm.deviceKey,
            accessToken: authState.accessToken,
            refreshToken: authState.refreshToken,
            createRequestText: createRequestText.value
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        };

        // 將操作紀錄寫入時間軸
        const appendLog = (level, messageText, payload) => {
          logs.value.unshift({
            id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
            level,
            message: messageText,
            payload: payload ? JSON.stringify(payload, null, 2) : '',
            time: new Date().toISOString()
          });
          if (logs.value.length > 40) {
            logs.value = logs.value.slice(0, 40);
          }
        };

        // ---------- 工具函式區 ----------

        // 建立固定的照片項目範本，符合營運提供的標準內容
        const buildPhotoItemTemplate = (photoUid) => {
          // 說明：統一整理傳入的 PhotoUID，避免前後端處理差異導致空白字串
          const normalizedPhoto = typeof photoUid === 'string' ? photoUid.trim() : '';

          return {
            photo: normalizedPhoto,
            position: '左前門',
            description: '建議同時處理刮痕',
            estimatedAmount: 4648
          };
        };

        // 確保 photos 物件具備四大類別陣列，並清理無效資料
        const ensurePhotoGroups = (payload) => {
          const target = payload || {};
          const groups = target.photos && typeof target.photos === 'object' ? target.photos : {};

          PHOTO_CATEGORY_KEYS.forEach((key) => {
            const source = Array.isArray(groups[key]) ? groups[key] : [];
            const normalizedItems = [];

            source.forEach((item) => {
              if (!item || typeof item !== 'object') {
                return;
              }

              // 說明：優先使用新版 photo 欄位，若仍帶入舊版陣列結構則擷取第一個有效 PhotoUID
              const directPhoto = typeof item.photo === 'string' ? item.photo.trim() : '';
              let photoValue = directPhoto;

              if (!photoValue && typeof item.photoUid === 'string') {
                photoValue = item.photoUid.trim();
              }

              if (!photoValue && Array.isArray(item.photos)) {
                const legacyPhoto = item.photos.find((photo) => photo && typeof photo.photoUid === 'string' && photo.photoUid.trim());
                if (legacyPhoto) {
                  photoValue = legacyPhoto.photoUid.trim();
                }
              }

              if (!photoValue) {
                return;
              }

              const normalizedItem = { ...item, photo: photoValue };
              delete normalizedItem.photos;
              delete normalizedItem.photoUid;
              normalizedItems.push(normalizedItem);
            });

            groups[key] = normalizedItems;
          });

        target.photos = groups;
        return groups;
      };

      // 說明：補齊維修分類折扣結構，確保操作流程仍能推入需要的分類資料
      const ensureMaintenanceCategoryAdjustments = (payload) => {
        if (!payload || typeof payload !== 'object') {
          return payload;
        }

        const maintenance = payload.maintenance && typeof payload.maintenance === 'object'
          ? payload.maintenance
          : {};

        const rawAdjustments = maintenance.categoryAdjustments && typeof maintenance.categoryAdjustments === 'object'
          ? maintenance.categoryAdjustments
          : {};

        const normalized = {};

        MAINTENANCE_CATEGORY_BASE_KEYS.forEach((key) => {
          normalized[key] = buildCategoryAdjustmentTemplate(rawAdjustments[key]);
        });

        maintenance.categoryAdjustments = normalized;
        payload.maintenance = maintenance;
        return payload;
      };

      // 說明：移除沒有實際資料的照片分類，避免輸出冗餘空陣列
      const prunePhotoGroupsForDisplay = (payload) => {
        if (!payload || typeof payload !== 'object') {
          return payload;
        }

        const photos = payload.photos && typeof payload.photos === 'object' ? payload.photos : null;
        if (!photos) {
          delete payload.photos;
          return payload;
        }

        const normalized = {};
        Object.keys(photos).forEach((category) => {
          const items = Array.isArray(photos[category]) ? photos[category] : [];
          const filtered = items
            .map((item) => {
              if (!item || typeof item !== 'object') {
                return null;
              }

              const photo = typeof item.photo === 'string' ? item.photo.trim() : '';
              if (!photo) {
                return null;
              }

              const normalizedItem = { photo };
              if (typeof item.position === 'string' && item.position.trim()) {
                normalizedItem.position = item.position.trim();
              }
              if (typeof item.description === 'string' && item.description.trim()) {
                normalizedItem.description = item.description.trim();
              }
              if (typeof item.dentStatus === 'string' && item.dentStatus.trim()) {
                normalizedItem.dentStatus = item.dentStatus.trim();
              }
              if (typeof item.fixType === 'string' && item.fixType.trim()) {
                normalizedItem.fixType = item.fixType.trim();
              }
              if (typeof item.estimatedAmount === 'number') {
                normalizedItem.estimatedAmount = item.estimatedAmount;
              }
              return normalizedItem;
            })
            .filter(Boolean);

          if (filtered.length > 0) {
            normalized[category] = filtered;
          }
        });

        if (Object.keys(normalized).length > 0) {
          payload.photos = normalized;
        } else {
          delete payload.photos;
        }

        return payload;
      };

      // 說明：整理維修設定，僅保留有填寫數值或文字的欄位
      const trimMaintenanceForDisplay = (payload) => {
        if (!payload || typeof payload !== 'object') {
          return payload;
        }

        const maintenance = payload.maintenance && typeof payload.maintenance === 'object'
          ? payload.maintenance
          : null;

        if (!maintenance) {
          delete payload.maintenance;
          return payload;
        }

        const normalized = {};

        const keepBoolean = (value) => value === true;
        const keepNumber = (value) => typeof value === 'number' && value !== 0;
        const keepString = (value) => typeof value === 'string' && value.trim();

        if (keepBoolean(maintenance.reserveCar)) {
          normalized.reserveCar = true;
        }
        if (keepBoolean(maintenance.applyCoating)) {
          normalized.applyCoating = true;
        }
        if (keepBoolean(maintenance.applyWrapping)) {
          normalized.applyWrapping = true;
        }
        if (keepBoolean(maintenance.hasRepainted)) {
          normalized.hasRepainted = true;
        }
        if (keepBoolean(maintenance.needToolEvaluation)) {
          normalized.needToolEvaluation = true;
        }

        if (keepNumber(maintenance.otherFee)) {
          normalized.otherFee = maintenance.otherFee;
        }
        if (keepNumber(maintenance.roundingDiscount)) {
          normalized.roundingDiscount = maintenance.roundingDiscount;
        }
        if (keepNumber(maintenance.percentageDiscount)) {
          normalized.percentageDiscount = maintenance.percentageDiscount;
        }
        if (keepString(maintenance.discountReason)) {
          normalized.discountReason = maintenance.discountReason.trim();
        }
        if (keepNumber(maintenance.estimatedRepairDays)) {
          normalized.estimatedRepairDays = maintenance.estimatedRepairDays;
        }
        if (keepNumber(maintenance.estimatedRepairHours)) {
          normalized.estimatedRepairHours = maintenance.estimatedRepairHours;
        }
        if (keepNumber(maintenance.estimatedRestorationPercentage)) {
          normalized.estimatedRestorationPercentage = maintenance.estimatedRestorationPercentage;
        }
        if (keepString(maintenance.suggestedPaintReason)) {
          normalized.suggestedPaintReason = maintenance.suggestedPaintReason.trim();
        }
        if (keepString(maintenance.unrepairableReason)) {
          normalized.unrepairableReason = maintenance.unrepairableReason.trim();
        }
        if (keepString(maintenance.remark)) {
          normalized.remark = maintenance.remark.trim();
        }

        const adjustments = maintenance.categoryAdjustments && typeof maintenance.categoryAdjustments === 'object'
          ? maintenance.categoryAdjustments
          : null;

        if (adjustments) {
          const filteredAdjustments = {};
          let hasActualAdjustment = false;

          Object.keys(adjustments).forEach((category) => {
            const template = buildCategoryAdjustmentTemplate(adjustments[category]);
            const hasOtherFee = keepNumber(template.otherFee);
            const hasDiscount = keepNumber(template.percentageDiscount);
            const hasReason = keepString(template.discountReason);
            if (hasOtherFee || hasDiscount || hasReason) {
              filteredAdjustments[category] = {
                otherFee: hasOtherFee ? template.otherFee : 0,
                percentageDiscount: hasDiscount ? template.percentageDiscount : 0,
                discountReason: hasReason ? template.discountReason.trim() : ''
              };
              hasActualAdjustment = true;
            }
          });

          if (hasActualAdjustment) {
            if (!Object.prototype.hasOwnProperty.call(filteredAdjustments, 'beauty')) {
              const beautyTemplate = buildCategoryAdjustmentTemplate(adjustments.beauty);
              const beautyOtherFee = keepNumber(beautyTemplate.otherFee);
              const beautyDiscount = keepNumber(beautyTemplate.percentageDiscount);
              const beautyReason = keepString(beautyTemplate.discountReason);
              filteredAdjustments.beauty = beautyOtherFee || beautyDiscount || beautyReason
                ? {
                    otherFee: beautyOtherFee ? beautyTemplate.otherFee : 0,
                    percentageDiscount: beautyDiscount ? beautyTemplate.percentageDiscount : 0,
                    discountReason: beautyReason ? beautyTemplate.discountReason.trim() : ''
                  }
                : {};
            }

            normalized.categoryAdjustments = filteredAdjustments;
          }
        }

        if (Object.keys(normalized).length > 0) {
          payload.maintenance = normalized;
        } else {
          delete payload.maintenance;
        }

        return payload;
      };

      // 說明：清理車體確認資料，僅保留簽名或有效標記
      const trimCarBodyConfirmationForDisplay = (payload) => {
        if (!payload || typeof payload !== 'object') {
          return payload;
        }

        const confirmation = payload.carBodyConfirmation && typeof payload.carBodyConfirmation === 'object'
          ? payload.carBodyConfirmation
          : null;

        if (!confirmation) {
          delete payload.carBodyConfirmation;
          return payload;
        }

        const normalized = {};
        if (typeof confirmation.signaturePhotoUid === 'string' && confirmation.signaturePhotoUid.trim()) {
          normalized.signaturePhotoUid = confirmation.signaturePhotoUid.trim();
        }

        if (Array.isArray(confirmation.damageMarkers)) {
          const markers = confirmation.damageMarkers
            .map((marker) => {
              if (!marker || typeof marker !== 'object') {
                return null;
              }

              const normalizedMarker = {
                x: typeof marker.x === 'number' ? marker.x : 0,
                y: typeof marker.y === 'number' ? marker.y : 0,
                hasDent: !!marker.hasDent,
                hasScratch: !!marker.hasScratch,
                hasPaintPeel: !!marker.hasPaintPeel
              };

              if (typeof marker.remark === 'string' && marker.remark.trim()) {
                normalizedMarker.remark = marker.remark.trim();
              }

              const hasDefect = normalizedMarker.hasDent || normalizedMarker.hasScratch || normalizedMarker.hasPaintPeel;
              if (!hasDefect && !normalizedMarker.remark) {
                return null;
              }

              return normalizedMarker;
            })
            .filter(Boolean);

          if (markers.length > 0) {
            normalized.damageMarkers = markers;
          }
        }

        if (Object.keys(normalized).length > 0) {
          payload.carBodyConfirmation = normalized;
        } else {
          delete payload.carBodyConfirmation;
        }

        return payload;
      };

      // 說明：移除店家欄位中空白或舊系統遺留的欄位
      const trimStoreInfoForDisplay = (payload) => {
        if (!payload || typeof payload !== 'object' || !payload.store || typeof payload.store !== 'object') {
          return payload;
        }

        const store = payload.store;
        const removableKeys = [
          'creatorTechnicianUid',
          'bookMethod',
          'reservationDate',
          'repairDate',
          'storeUid',
          'storeName',
          'storeCode',
          'estimationTechnicianName',
          'creatorTechnicianName'
        ];

        removableKeys.forEach((key) => {
          const value = store[key];
          if (value == null || (typeof value === 'string' && !value.trim())) {
            delete store[key];
          }
        });

        return payload;
      };

        // 套用圖片至指定類別，允許多筆資料堆疊以模擬多處損傷
        const appendPhotoItem = (photoUid, options = {}) => {
          const { notify = true, log = true, category = 'dent' } = options;
          if (!photoUid) {
            if (notify) {
              message.warning('請先建立或輸入損傷用 PhotoUID。');
            }
            return { success: false };
          }

          try {
            const parsed = JSON.parse(createRequestText.value || '{}');
            const groups = ensurePhotoGroups(parsed);
            ensureMaintenanceCategoryAdjustments(parsed);
            // 說明：若未指定或帶入無效類別則回退至凹痕分類，確保資料結構一致
            const normalizedCategory = PHOTO_CATEGORY_KEYS.includes(category) ? category : 'dent';

            const payload = buildPhotoItemTemplate(photoUid);
            groups[normalizedCategory] = groups[normalizedCategory] || [];
            groups[normalizedCategory].push(payload);

            prunePhotoGroupsForDisplay(parsed);
            trimMaintenanceForDisplay(parsed);
            createRequestText.value = JSON.stringify(parsed, null, 2);
            persistSettings();

            const displayName = PHOTO_CATEGORY_DISPLAY[normalizedCategory] || normalizedCategory;

            if (notify) {
              message.success(`已新增一筆${displayName}類別照片資料並套用指定圖片。`);
            }

            if (log) {
              appendLog('success', '新增分類照片資料並套用圖片', {
                photoUid,
                category: normalizedCategory,
                displayName,
                item: payload
              });
            }

            return { success: true, payload };
          } catch (error) {
            if (notify) {
              message.warning('JSON 解析失敗，請確認內容格式是否正確。');
            }
            if (log) {
              appendLog('warning', '新增分類照片資料失敗', { message: error.message });
            }
            return { success: false, error };
          }
        };

        // 套用指定圖片至車體簽名欄位，確保簽名必填資料齊全
        const applySignaturePhoto = (photoUid, { notify = true, log = true } = {}) => {
          if (!photoUid) {
            if (notify) {
              message.warning('請先建立或輸入簽名用 PhotoUID。');
            }
            return { success: false };
          }

          try {
            const parsed = JSON.parse(createRequestText.value || '{}');

            if (!parsed.carBodyConfirmation || typeof parsed.carBodyConfirmation !== 'object') {
              parsed.carBodyConfirmation = {};
            }

            parsed.carBodyConfirmation.signaturePhotoUid = photoUid;
            if (!Array.isArray(parsed.carBodyConfirmation.damageMarkers)) {
              parsed.carBodyConfirmation.damageMarkers = [];
            }

            createRequestText.value = JSON.stringify(parsed, null, 2);
            persistSettings();

            if (notify) {
              message.success('已套用簽名照片 UID。');
            }

            if (log) {
              appendLog('success', '簽名照片 UID 已更新', { photoUid });
            }

            return { success: true };
          } catch (error) {
            if (notify) {
              message.warning('JSON 解析失敗，請確認內容格式是否正確。');
            }
            if (log) {
              appendLog('warning', '簽名照片 UID 套用失敗', { message: error.message });
            }
            return { success: false, error };
          }
        };

        // 處理 API 回傳的 ProblemDetails，統一提示錯誤
        const handleProblemDetails = async (response) => {
          let details = await safeReadJson(response);
          if (!details) {
            details = { title: '未知錯誤', detail: await response.text() };
          }
          const description = details.detail || details.title || '發生未知錯誤';
          message.error(description);
          appendLog('danger', `API 回應錯誤：${response.status}`, details);
          throw new Error(description);
        };

        // 安全解析 JSON，避免因空白字串導致例外
        const safeReadJson = async (response) => {
          try {
            return await response.clone().json();
          } catch (error) {
            return null;
          }
        };

        // 登入取得 Access Token 與 Refresh Token
        const login = async () => {
          if (!loginForm.deviceKey.trim()) {
            message.warning('請先輸入裝置機碼。');
            return;
          }

          loading.login = true;
          try {
            const response = await fetch(buildUrl('/auth/login'), {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ deviceKey: loginForm.deviceKey.trim() })
            });

            if (!response.ok) {
              await handleProblemDetails(response);
              return;
            }

            const data = await response.json();
            applyLoginResponse(data);
            message.success('登入成功，已取得 Access Token。');
            appendLog('success', '登入成功', data);
            persistSettings();
          } catch (error) {
            appendLog('danger', '登入流程發生錯誤', { message: error.message });
          } finally {
            loading.login = false;
          }
        };

        // 透過 Refresh Token 換取新的 Access Token
        const refreshToken = async () => {
          if (!authState.refreshToken) {
            message.warning('目前沒有 Refresh Token，請先登入。');
            return;
          }

          loading.refresh = true;
          try {
            const response = await fetch(buildUrl('/auth/token/refresh'), {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                refreshToken: authState.refreshToken,
                deviceKey: loginForm.deviceKey.trim()
              })
            });

            if (!response.ok) {
              await handleProblemDetails(response);
              return;
            }

            const data = await response.json();
            applyLoginResponse(data);
            message.success('已刷新 Access Token。');
            appendLog('success', '刷新 Access Token 成功', data);
            persistSettings();
          } catch (error) {
            appendLog('danger', '刷新 Token 發生錯誤', { message: error.message });
          } finally {
            loading.refresh = false;
          }
        };

        // 取得登入者資訊，確認權杖是否有效
        const fetchUserInfo = async () => {
          if (!hasToken.value) {
            message.warning('請先登入以取得權杖。');
            return;
          }

          try {
            const response = await fetch(buildUrl('/auth/info'), {
              headers: {
                Authorization: `Bearer ${authState.accessToken}`
              }
            });

            if (!response.ok) {
              await handleProblemDetails(response);
              return;
            }

            const data = await response.json();
            appendLog('info', '取得登入者資訊', data);
            message.success('已取得登入者資訊。');
          } catch (error) {
            appendLog('danger', '取得登入者資訊失敗', { message: error.message });
          }
        };

        // 套用登入回傳內容至狀態物件
        const applyLoginResponse = (data) => {
          authState.accessToken = data.accessToken || '';
          authState.refreshToken = data.refreshToken || '';
          authState.displayName = data.displayName || '';
          authState.role = data.role || '';
          authState.deviceStatus = data.deviceStatus || '';
          authState.message = data.message || '';
          authState.accessTokenExpireAt = data.accessTokenExpireAt || '';
          authState.refreshTokenExpireAt = data.refreshTokenExpireAt || '';
        };

        // 從後端取得估價單建立的隨機草稿資料
        // 清理草稿中不再需要顯示的舊欄位，避免測試頁面混淆前端開發者
        const sanitizeDraftForDisplay = (draft) => {
          if (!draft || typeof draft !== 'object') {
            return draft;
          }

          const clone = JSON.parse(JSON.stringify(draft));

          if (clone.car && typeof clone.car === 'object') {
            // 移除車輛區塊中已廢棄的 UID 與里程欄位
            ['brandUid', 'modelUid', 'mileage'].forEach((key) => {
              if (clone.car[key] == null) {
                delete clone.car[key];
              }
            });
          }

          if (clone.carBodyConfirmation && typeof clone.carBodyConfirmation === 'object') {
            // 舊版標註圖與簽名欄位改以 PhotoUID 呈現，因此一律剔除
            delete clone.carBodyConfirmation.annotatedImage;
            delete clone.carBodyConfirmation.signature;
          }

          if (clone.maintenance && typeof clone.maintenance === 'object') {
            // 舊版工時欄位改由預估天數與小時呈現，測試資料不再顯示
            ['fixTimeHour', 'fixTimeMin', 'fixExpectDay', 'fixExpectHour'].forEach((key) => {
              if (key in clone.maintenance) {
                delete clone.maintenance[key];
              }
            });
          }

          ensurePhotoGroups(clone);
          ensureMaintenanceCategoryAdjustments(clone);
          prunePhotoGroupsForDisplay(clone);
          trimMaintenanceForDisplay(clone);
          trimCarBodyConfirmationForDisplay(clone);
          trimStoreInfoForDisplay(clone);

          return clone;
        };

        const fetchRandomDraft = async () => {
          if (!hasToken.value) {
            message.warning('請先完成登入。');
            return;
          }

          loading.random = true;
          try {
            const response = await fetch(buildUrl('/quotations/create/random-test'), {
              headers: {
                Authorization: `Bearer ${authState.accessToken}`
              }
            });

            if (!response.ok) {
              await handleProblemDetails(response);
              return;
            }

            const data = await response.json();
            const sanitizedDraft = sanitizeDraftForDisplay(data.draft);
            createRequestText.value = JSON.stringify(sanitizedDraft, null, 2);
            randomSummary.technician = normalizeSummary(data.technician);
            randomSummary.store = normalizeSummary(data.store);
            randomSummary.customer = normalizeSummary(data.customer);
            randomSummary.car = normalizeSummary(data.car);
            randomSummary.fixType = typeof data.fixType === 'string' ? data.fixType : '';
            randomSummary.generatedAt = data.generatedAt;
            randomSummary.notes = Array.isArray(data.notes) ? data.notes : [];
            message.success('已取得隨機測試資料並套用至 JSON。');
            appendLog('success', '取得估價單測試草稿成功', data);
            persistSettings();
          } catch (error) {
            appendLog('danger', '取得估價單測試草稿失敗', { message: error.message });
          } finally {
            loading.random = false;
          }
        };

        // 將摘要物件正規化為統一格式
        const normalizeSummary = (entity) => {
          if (!entity) {
            return null;
          }
          return {
            uid: entity.uid || entity.Uid || '',
            name: entity.name || entity.Name || '',
            description: entity.description || entity.Description || ''
          };
        };

        // 以空白 Base64 產生圖片檔案並上傳取得 PhotoUID，依目標分類儲存
        const uploadBlankPhoto = async (target) => {
          if (!hasToken.value) {
            message.warning('請先登入取得 Access Token。');
            return;
          }

          const loadingKey = target === 'signature' ? 'signaturePhoto' : 'damagePhoto';
          const targetName = target === 'signature' ? '簽名' : '損傷';
          loading[loadingKey] = true;
          try {
            const blob = base64ToBlob(BLANK_IMAGE_BASE64);
            const file = new File([blob], `blank-${Date.now()}.png`, { type: blob.type });
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(buildUrl('/photos'), {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${authState.accessToken}`
              },
              body: formData
            });

            if (!response.ok) {
              await handleProblemDetails(response);
              return;
            }

            const data = await response.json();
            const photoUid = data.photoUid || '';

            if (target === 'signature') {
              signaturePhotoUid.value = photoUid;
              message.success('已建立簽名空白圖片並取得 PhotoUID。');
              appendLog('success', '建立簽名空白圖片成功', data);
              const result = applySignaturePhoto(photoUid, { notify: false });
              if (result.success) {
                appendLog('success', '簽名空白圖片已自動套用', { photoUid });
              }
            } else {
              damagePhotoUid.value = photoUid;
              message.success('已建立損傷空白圖片並取得 PhotoUID。');
              appendLog('success', '建立損傷空白圖片成功', data);
              const result = appendPhotoItem(photoUid, { notify: false });
              if (result.success) {
                appendLog('success', '損傷空白圖片已自動新增損傷資料', { photoUid });
              }
            }
          } catch (error) {
            appendLog('danger', `建立${targetName}空白圖片失敗`, { message: error.message });
          } finally {
            loading[loadingKey] = false;
          }
        };

        // 透過最新損傷圖片新增損傷陣列資料
        const appendDamageWithPhoto = () => {
          appendPhotoItem(damagePhotoUid.value, {});
        };

        // 透過最新簽名圖片套用簽名照片 UID
        const applySignatureWithPhoto = () => {
          applySignaturePhoto(signaturePhotoUid.value, {});
        };

        // 建立損傷專用空白圖片
        const createDamageBlankPhoto = () => uploadBlankPhoto('damage');

        // 建立簽名專用空白圖片
        const createSignatureBlankPhoto = () => uploadBlankPhoto('signature');

        // 將 Base64 字串轉換為 Blob 物件
        const base64ToBlob = (base64) => {
          const segments = base64.split(',');
          const meta = segments[0];
          const data = segments[1] || '';
          const match = /data:(.*);base64/.exec(meta);
          const contentType = match ? match[1] : 'application/octet-stream';
          const byteCharacters = atob(data);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i += 1) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          return new Blob([byteArray], { type: contentType });
        };

        // 送出建立估價單請求
        const createQuotation = async () => {
          if (!hasToken.value) {
            message.warning('請先登入取得 Access Token。');
            return;
          }

          let parsed;
          try {
            parsed = JSON.parse(createRequestText.value);
          } catch (error) {
            message.error('JSON 格式錯誤，請確認內容。');
            appendLog('danger', 'JSON 解析失敗', { message: error.message });
            return;
          }

          ensurePhotoGroups(parsed);
          ensureMaintenanceCategoryAdjustments(parsed);
          prunePhotoGroupsForDisplay(parsed);
          trimMaintenanceForDisplay(parsed);
          trimCarBodyConfirmationForDisplay(parsed);
          trimStoreInfoForDisplay(parsed);

          loading.create = true;
          try {
            const response = await fetch(buildUrl('/quotations/create'), {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${authState.accessToken}`
              },
              body: JSON.stringify(parsed)
            });

            if (!response.ok) {
              await handleProblemDetails(response);
              return;
            }

            const data = await response.json();
            createResponse.value = JSON.stringify(data, null, 2);
            message.success('估價單建立成功。');
            appendLog('success', '估價單建立成功', data);
          } catch (error) {
            appendLog('danger', '估價單建立失敗', { message: error.message });
          } finally {
            loading.create = false;
          }
        };

        // 重新套用最近一次取得的草稿資料
        const loadDraftAgain = () => {
          if (randomSummary.generatedAt) {
            fetchRandomDraft();
          } else {
            message.info('尚未取得過測試草稿。');
          }
        };

        // 將 JSON 內容重新縮排，方便閱讀
        const formatRequestJson = () => {
          try {
            const parsed = JSON.parse(createRequestText.value);
            ensurePhotoGroups(parsed);
            ensureMaintenanceCategoryAdjustments(parsed);
            prunePhotoGroupsForDisplay(parsed);
            trimMaintenanceForDisplay(parsed);
            trimCarBodyConfirmationForDisplay(parsed);
            trimStoreInfoForDisplay(parsed);
            createRequestText.value = JSON.stringify(parsed, null, 2);
            message.success('已格式化 JSON。');
            persistSettings();
          } catch (error) {
            message.error('無法格式化，請確認 JSON 是否正確。');
          }
        };

        // 複製 JSON 內容至剪貼簿
        const copyRequest = async () => {
          try {
            await navigator.clipboard.writeText(createRequestText.value);
            message.success('已複製至剪貼簿。');
          } catch (error) {
            message.error('瀏覽器阻擋複製，請手動選取內容。');
          }
        };

        // 清除權杖資訊
        const clearTokens = () => {
          authState.accessToken = '';
          authState.refreshToken = '';
          authState.displayName = '';
          authState.role = '';
          authState.deviceStatus = '';
          authState.message = '';
          authState.accessTokenExpireAt = '';
          authState.refreshTokenExpireAt = '';
          persistSettings();
        };

        // 清空操作紀錄
        const clearLogs = () => {
          logs.value = [];
        };

        // 將時間字串轉換為可讀格式
        const formatTimestamp = (value) => {
          if (!value) {
            return '-';
          }
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) {
            return value;
          }
          return new Intl.DateTimeFormat('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          }).format(date);
        };

        // ---------- 生命週期 ----------
        onMounted(() => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const parsed = JSON.parse(saved);
              if (parsed.baseUrl) baseUrl.value = parsed.baseUrl;
              if (parsed.deviceKey) loginForm.deviceKey = parsed.deviceKey;
              if (parsed.accessToken) authState.accessToken = parsed.accessToken;
              if (parsed.refreshToken) authState.refreshToken = parsed.refreshToken;
              if (parsed.createRequestText) {
                try {
                  const restored = JSON.parse(parsed.createRequestText);
                  ensurePhotoGroups(restored);
                  ensureMaintenanceCategoryAdjustments(restored);
                  prunePhotoGroupsForDisplay(restored);
                  trimMaintenanceForDisplay(restored);
                  trimCarBodyConfirmationForDisplay(restored);
                  trimStoreInfoForDisplay(restored);
                  createRequestText.value = JSON.stringify(restored, null, 2);
                } catch (error) {
                  console.warn('載入儲存估價單 JSON 時解析失敗，將沿用原字串。', error);
                  createRequestText.value = parsed.createRequestText;
                }
              }
            }
          } catch (error) {
            console.warn('載入儲存設定時發生錯誤：', error);
          }
        });

        watch(
          () => ({
            baseUrl: baseUrl.value,
            deviceKey: loginForm.deviceKey,
            accessToken: authState.accessToken,
            refreshToken: authState.refreshToken,
            createRequestText: createRequestText.value
          }),
          () => {
            persistSettings();
          },
          { deep: true }
        );

        return {
          locale,
          baseUrl,
          loginForm,
          authState,
          loading,
          hasToken,
          canUseDamagePhoto,
          canUseSignaturePhoto,
          randomSummary,
          damagePhotoUid,
          signaturePhotoUid,
          createRequestText,
          createResponse,
          logs,
          login,
          refreshToken,
          fetchUserInfo,
          fetchRandomDraft,
          uploadBlankPhoto,
          appendDamageWithPhoto,
          applySignatureWithPhoto,
          createDamageBlankPhoto,
          createSignatureBlankPhoto,
          createQuotation,
          formatRequestJson,
          copyRequest,
          clearTokens,
          clearLogs,
          formatTimestamp,
          loadDraftAgain
        };
      }
    };

    createApp(App).use(elementPlus, { locale: zhTwLocale }).mount('#app');
  </script>
</body>
</html>
